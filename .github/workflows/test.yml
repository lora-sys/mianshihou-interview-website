# CI 配置 - 只运行单元测试
name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # 任务 1：运行单元测试
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 设置 Bun
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      # 3. 安装依赖
      - name: Install dependencies
        run: |
          cd mianshihou/apps/api
          bun install

      # 4. 运行单元测试
      - name: Run unit tests
        run: |
          cd mianshihou/apps/api
          bun test tests/unit

      # 5. 生成覆盖率报告
      - name: Generate coverage
        run: |
          cd mianshihou/apps/api
          bun test tests/unit --coverage

      # 6. 上传覆盖率报告
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: mianshihou/apps/api/coverage/

  # 任务 2：代码质量检查
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    
    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 设置 Bun
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      # 3. 安装依赖
      - name: Install dependencies
        run: |
          cd mianshihou/apps/api
          bun install

      # 4. 运行 TypeScript 检查
      - name: TypeScript check
        run: |
          cd mianshihou/apps/api
          bun run build