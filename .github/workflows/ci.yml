name: CI/CD Pipeline

# 触发条件：当推送到 main 分支或创建 Pull Request 时
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# 环境变量
env:
  NODE_VERSION: '18'
  BUN_VERSION: 'latest'

jobs:
  # 任务 1：运行测试
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 设置 Bun 运行环境
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      # 3. 安装依赖
      - name: Install dependencies
        run: |
          cd mianshihou/apps/api
          bun install

      # 4. 运行单元测试
      - name: Run unit tests
        run: |
          cd mianshihou/apps/api
          bun test tests/unit

      # 5. 运行集成测试
      - name: Run integration tests
        run: |
          cd mianshihou/apps/api
          bun test tests/integration

      # 6. 生成覆盖率报告
      - name: Generate coverage report
        run: |
          cd mianshihou/apps/api
          bun test --coverage

      # 7. 上传覆盖率报告
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: mianshihou/apps/api/coverage/

  # 任务 2：代码质量检查
  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 设置 Bun 运行环境
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      # 3. 安装依赖
      - name: Install dependencies
        run: |
          cd mianshihou/apps/api
          bun install

      # 4. 运行 ESLint
      - name: Run ESLint
        run: |
          cd mianshihou/apps/api
          bun run lint || echo "Lint not configured, skipping..."

      # 5. 运行 TypeScript 类型检查
      - name: Run TypeScript check
        run: |
          cd mianshihou/apps/api
          bun run build

  # 任务 3：数据库迁移检查
  database:
    name: Database Migration Check
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: mianshihou
          POSTGRES_PASSWORD: 123456
          POSTGRES_DB: mianshihou_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 设置 Bun 运行环境
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      # 3. 安装依赖
      - name: Install dependencies
        run: |
          cd mianshihou/apps/api
          bun install

      # 4. 等待数据库就绪
      - name: Wait for database
        run: |
          sleep 5
          cd mianshihou/apps/api
          bun run test-db

      # 5. 运行数据库迁移
      - name: Run database migration
        run: |
          cd mianshihou/apps/api
          bun run db:push

  # 任务 4：构建项目
  build:
    name: Build Project
    runs-on: ubuntu-latest
    needs: [test, lint]
    
    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 设置 Bun 运行环境
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      # 3. 安装依赖
      - name: Install dependencies
        run: |
          cd mianshihou/apps/api
          bun install

      # 4. 构建项目
      - name: Build project
        run: |
          cd mianshihou/apps/api
          bun run build

      # 5. 上传构建产物
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: mianshihou/apps/api/dist/

  # 任务 5：安全检查（可选）
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 运行依赖安全检查
      - name: Run security audit
        run: |
          cd mianshihou/apps/api
          bun audit || echo "Audit completed with warnings"

      # 3. 检查敏感信息
      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD