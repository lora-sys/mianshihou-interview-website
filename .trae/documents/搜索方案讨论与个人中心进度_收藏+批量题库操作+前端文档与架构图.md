## 搜索怎么整（先讨论结论）

- **现状**：现在所有“搜索”都是 `title like '%关键词%'`（题目/题库/Explore 一样），数据库已预留 `questions.embedding vector(1536)` + HNSW 索引，但还没有生成 embedding 或向量检索 API。

- **我建议分 3 阶段做**（兼顾 UX、成本、未来语义检索）：
  1. **Phase 1（立刻可用）统一关键词搜索页**：
     - 新增 `/search`（或 `/explore/search`），一次输入同时返回：系统题库、系统题目；登录后再额外返回“我的题库/我的题目”。

     - 查询维度：`title` +（可选）`tags`（因为 tags 存 JSON 字符串，最简单做 `like`）；`content` 暂时不做，避免误匹配太多和性能抖动。

     - 排序：优先精确匹配（title 前缀）> contains；其次按 `updateTime`。

  2. **Phase 2（更像真实搜索）pg_trgm / 全文**：
     - 引入 `pg_trgm` + `gin`/`gist` trigram index，让 `ILIKE`/相似度更快、更“模糊友好”。

     - 或上 `tsvector`（全文检索）做 content 索引（更重，但更准）。

  3. **Phase 3（语义/混合）pgvector 混合检索**：
     - 增加 embedding 生成任务（写入 `questions.embedding`）。

     - 搜索时做 hybrid：keyword topN ∪ vector topN，再按加权分排序。

## 个人中心：『我的收藏 / 练习进度』+ 贡献图

- **现状**：没有题目收藏表、没有练习记录表；dashboard 的“已完成练习/平均得分”是 TODO 占位。

- **方案**：新增两张轻量表 + 两类 API：
  - `question_favorite`：用户收藏题目（可收藏系统题，也可收藏自己的题）。

  - `practice_record`（或 `question_practice`）：记录练习事件（最少字段：userId、questionId、doneAt、score 可选）。

- **贡献图（GitHub 风格）**：后端提供最近 365 天每日完成数聚合；前端用纯 SSR 渲染一个 7x53 的 grid（不依赖图表库），hover 显示当天数量与日期。

- **我的收藏页面**：/me 下新增“收藏题目列表”入口（支持筛选系统/我的）。

## 批量：题目加入题库/移出题库/批量删除/批量导入

- **现状**：题库-题目关联只有单个 `addQuestion/removeQuestion`，没有批量。

- **方案**：
  - API：新增 `questionBanks.batchAddQuestions`、`questionBanks.batchRemoveQuestions`（输入：questionBankId + questionIds\[]），保证：
    - 事务内处理去重、忽略已存在、正确维护 `question_count`。

    - 权限：用户只能操作自己的题库；管理员可操作系统题库。

  - UI：在“我的题目列表/管理员题目列表”提供勾选多条题目 → 选择目标题库 → 批量加入。

  - 导入：先支持 CSV/JSON 上传后解析批量创建题目并可选择题库落入（管理员可导入到系统题库）。

## 前端功能梳理 + 坑点总结 + 架构图（输出到 apps/web/docs）

- **文档清单**（都会写到 `/apps/web/docs`）：
  - `前端功能清单.md`：路由分区（Explore/我的/Admin/Account）、各页面支持能力。

  - `搜索方案.md`：上面 3 阶段 + API 设计 + 排序策略 + 索引策略。

  - `批量操作设计.md`：批量加入/移除/导入的接口、权限、事务策略。

  - `坑点总结.md`：当前项目的坑（SSR fetch failed、Next middleware 保护策略、tRPC batch input 格式、Better-Auth role 同步等）。

- **架构图**：生成一个 Excalidraw（Obsidian 兼容）文件，画出：
  - Web（Next SSR + Route Handlers + middleware）

  - API（Fastify + tRPC + Better-Auth + Drizzle + Postgres/Redis）

  - 数据域分层（系统内容 vs 用户内容）

  - 搜索演进（like → trgm/tsvector → pgvector hybrid）

## 端到端验证

- 启动 `apps/api dev` + `apps/web dev`。

- 验证路径：
  - 未登录：`/`、`/explore/*` 可用；`/search` 可搜系统内容。

  - 登录：`/me` 有收藏与贡献图；收藏/练习动作会更新。

  - 批量：勾选题目批量加入题库、批量移除、导入。

- Admin：同样支持对系统题库/题目执行批量操作。

补充：后端已有点赞/收藏（postThumb/postFavour）一套完整 router，可以直接复用其“数据模型与接口形态”作为题目域的模板：新增 questionThumb/questionFavour（或统一 reaction 表），并改为基于 ctx.user 的鉴权（避免入参传 userId）。

如果你确认按这个方案推进，我会按顺序落地：

1. Search page + 统一搜索 API（Phase 1）
2. 收藏/练习表 + API + /me 贡献图
3. 批量加入/移除/导入（用户与管理员两套 UI）
4. apps/web/docs 的文档与 Excalidraw 架构图
