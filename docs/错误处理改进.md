# 错误处理改进文档

## 概述

本文档记录了面试后项目错误处理系统的改进过程，包括统一错误响应格式、Zod 错误处理优化等内容。

## 改进目标

1. **统一错误响应格式** - 所有错误返回统一的 JSON 格式
2. **优化 Zod 错误处理** - 自动识别和格式化 Zod 验证错误
3. **增强错误日志** - 记录详细的错误上下文信息
4. **智能状态码映射** - 自动将错误代码映射到正确的 HTTP 状态码

## 实现的功能

### 1. 统一错误响应格式

所有错误现在都返回统一的 JSON 格式：

```json
{
  "success": false,
  "error": {
    "message": "错误信息",
    "code": "错误代码",
    "stack": "堆栈信息（仅开发环境）"
  }
}
```

**实现位置**: `mianshihou/apps/api/server.ts`

```typescript
fastify.setErrorHandler((error: any, request, reply) => {
  const isZodError = error.name === 'ZodError' && error.errors;

  const errorResponse: any = {
    success: false,
    error: {
      message: error.message || '服务器内部错误',
      code: error.code || 'INTERNAL_SERVER_ERROR',
    },
  };

  // ... 处理 Zod 错误和状态码映射
  reply.send(errorResponse);
});
```

### 2. Zod 错误处理优化

#### 自动识别 Zod 错误

在 `middlewares/logger.ts` 中添加了 Zod 错误识别：

```typescript
function isZodError(error: any): boolean {
  return error && error.name === 'ZodError' && error.errors;
}
```

#### 格式化 Zod 错误信息

```typescript
function formatZodError(error: any): Array<{ path: string; message: string }> {
  if (!error.errors || !Array.isArray(error.errors)) return [];

  return error.errors.map((e: any) => ({
    path: e.path.length > 0 ? e.path.join('.') : 'root',
    message: e.message,
  }));
}
```

#### Zod 错误响应格式

```json
{
  "success": false,
  "error": {
    "message": "参数验证失败",
    "code": "VALIDATION_ERROR",
    "validationErrors": [
      { "path": "email", "message": "Invalid email format" },
      { "path": "password", "message": "Password too short" }
    ]
  }
}
```

### 3. HTTP 状态码映射

添加了 `getStatusCodeFromCode()` 函数，将 tRPC 错误代码映射到正确的 HTTP 状态码：

```typescript
function getStatusCodeFromCode(code: string): number {
  const codeMap: Record<string, number> = {
    'BAD_REQUEST': 400,
    'UNAUTHORIZED': 401,
    'FORBIDDEN': 403,
    'NOT_FOUND': 404,
    'INTERNAL_SERVER_ERROR': 500,
  };
  return codeMap[code] || 500;
}
```

**状态码映射**:
- `BAD_REQUEST` → 400
- `UNAUTHORIZED` → 401
- `FORBIDDEN` → 403
- `NOT_FOUND` → 404
- `INTERNAL_SERVER_ERROR` → 500

### 4. 错误日志增强

在 `middlewares/logger.ts` 的 `errorLogger` 中：

```typescript
export function errorLogger(fastify: FastifyInstance) {
  fastify.addHook('onError', async (request: FastifyRequest, reply: FastifyReply, error: Error) => {
    const errorInfo: any = {
      message: error.message,
      name: error.name,
      stack: process.env.NODE_ENV === 'development' ? error.stack : undefined,
    };

    // 处理 Zod 验证错误
    if (isZodError(error)) {
      errorInfo.validationErrors = formatZodError(error);
      errorInfo.formattedMessage = `参数验证失败: ${errorInfo.validationErrors.map((e: any) => `${e.path}: ${e.message}`).join(', ')}`;
    }

    logger.error('请求错误', {
      request: extractRequestInfo(request),
      error: errorInfo,
      response: {
        statusCode: reply.statusCode,
      },
      timestamp: new Date().toISOString(),
    });
  });
}
```

### 5. 现有的全局异常处理

`lib/exception.ts` 已经提供了完整的全局异常处理功能：

```typescript
// 使用示例
import { throwIfNull } from './lib/exception';
import { ErrorType } from './lib/errors';

// 检查资源是否存在
throwIfNull(user, ErrorType.USER_NOT_FOUND);

// 条件抛出异常
throwIf(condition, ErrorType.FORBIDDEN, '无权限访问');
```

## 测试覆盖

### 测试文件

`tests/unit/error-handler.test.ts`

### 测试场景

1. ✅ 统一错误响应格式
2. ✅ HTTP 状态码处理（404、401等）
3. ✅ Zod 验证错误识别
4. ✅ Zod 验证错误格式化
5. ✅ Zod 错误路径格式化
6. ✅ 开发环境堆栈信息
7. ✅ 错误日志记录

### 测试结果

```
8 pass
0 fail
22 expect() calls
Ran 8 tests across 1 file.
```

## 使用示例

### 抛出错误

使用现有的 `lib/exception.ts`：

```typescript
import { throwIfNull, throwIf } from './lib/exception';
import { ErrorType } from './lib/errors';

// 检查用户是否存在
throwIfNull(user, ErrorType.USER_NOT_FOUND);

// 自定义消息
throwIfNull(user, ErrorType.USER_NOT_FOUND, '用户不存在', { userId });

// 条件抛出异常
throwIf(!hasPermission, ErrorType.FORBIDDEN, '无权限访问');
```

### Zod 验证错误

```typescript
import { z } from 'zod';

const schema = z.object({
  email: z.string().email(),
  password: z.string().min(8),
});

// 验证失败时自动返回格式化的错误响应
const result = schema.parse(data);
```

## 错误代码定义

所有错误代码在 `lib/errors.ts` 中定义：

```typescript
export enum ErrorType {
  // 通用错误
  UNKNOWN = 'UNKNOWN',
  INVALID_PARAMS = 'INVALID_PARAMS',

  // 用户相关错误
  USER_NOT_FOUND = 'USER_NOT_FOUND',
  USER_ALREADY_EXISTS = 'USER_ALREADY_EXISTS',
  INVALID_PASSWORD = 'INVALID_PASSWORD',

  // 权限错误
  UNAUTHORIZED = 'UNAUTHORIZED',
  FORBIDDEN = 'FORBIDDEN',

  // 资源错误
  RESOURCE_NOT_FOUND = 'RESOURCE_NOT_FOUND',
  RESOURCE_ALREADY_EXISTS = 'RESOURCE_ALREADY_EXISTS',

  // 业务错误
  OPERATION_FAILED = 'OPERATION_FAILED',
  DUPLICATE_OPERATION = 'DUPLICATE_OPERATION',
}
```

## 依赖关系

- `lib/errors.ts` - 错误类型定义
- `lib/exception.ts` - 全局异常处理器
- `middlewares/logger.ts` - 日志中间件
- `server.ts` - Fastify 错误处理器

## 注意事项

1. **使用现有的 exception.ts** - 不要重复创建自定义错误类
2. **统一响应格式** - 所有错误都应返回统一格式
3. **Zod 错误自动处理** - 不需要手动处理 Zod 验证错误
4. **开发环境堆栈** - 只在开发环境显示堆栈信息
5. **测试覆盖** - 确保所有错误场景都有测试覆盖

## 后续优化建议

1. 添加更多业务错误类型
2. 实现错误追踪系统
3. 添加错误统计和分析
4. 实现错误降级策略
5. 添加错误监控告警

## 相关文档

- [API 接口文档](./api-documentation/api-documentation.md)
- [错误日志](./error-log/error-log.md)

## 更新记录

- 2026-01-30: 完成错误处理系统改进
  - 统一错误响应格式
  - 优化 Zod 错误处理
  - 增强错误日志
  - 添加完整测试覆盖