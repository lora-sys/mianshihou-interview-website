# 后端架构总结

## 概述

面试后端系统采用现代化的技术栈和架构设计，以 Fastify 为核心框架，tRPC 实现 API 层，构建了一个类型安全、高性能、安全可靠的后端服务。

## 核心架构

### 1. 分层架构

系统采用清晰的分层架构，各层职责明确：

```
客户端 → Fastify Server → tRPC Router → 业务逻辑 → 数据持久化
         ↓                    ↓
      中间件层           工具库层
         ↓                    ↓
    Fastify 中间件    认证、缓存、安全
```

### 2. 技术选型

**核心框架**
- Fastify: 高性能 Web 框架，提供出色的请求处理能力
- tRPC: 类型安全的 API 层，实现前后端类型共享
- Better-Auth: 现代化认证框架，支持多种认证方式

**数据存储**
- PostgreSQL: 主数据库，使用 Drizzle ORM 实现类型安全的数据库操作
- Redis: 缓存层，提供高性能的数据缓存和会话存储

**安全防护**
- 多层安全防护体系，包括请求限流、SQL 注入防护、XSS 防护、IP 访问控制、API 签名验证

## 主要功能模块

### 1. 认证与授权

**Better-Auth 集成**
- 支持邮箱密码登录
- 支持 OAuth 第三方登录 (Google, GitHub)
- 会话管理

**设备识别与并发控制**
- 设备指纹识别 (User-Agent + 其他特征)
- 并发登录检测和限制
- 多设备管理 (查看、踢出设备)

**权限管理**
- 基于角色的访问控制 (RBAC)
- adminProcedure: 管理员权限
- adminOrOwnerProcedure: 管理员或所有者权限
- publicProcedure: 公开访问
- protectedProcedure: 需要登录

### 2. 业务模块

**用户管理**
- 用户 CRUD 操作
- 批量创建/删除用户
- 数据脱敏 (密码、敏感信息)

**题库管理**
- 题库 CRUD 操作
- 批量创建/删除题库
- 题库题目关联

**题目管理**
- 题目 CRUD 操作
- 批量创建/删除题目
- 题目标签、答案管理

**社区功能**
- 帖子管理 (CRUD)
- 点赞功能
- 收藏功能

**文件上传**
- 头像上传 (200x200, 5MB)
- 附件上传 (1920x1080, 10MB)
- 文件删除和管理
- 图片自动压缩处理

### 3. 安全防护体系

**请求限流**
- Redis 滑动窗口算法
- 支持按用户、IP、端点配置
- 防止 API 滥用和 DDoS 攻击

**SQL 注入防护**
- 输入验证
- SQL 关键词检测
- 危险字符过滤

**XSS 防护**
- HTML 实体编码
- DOMPurify 清理
- JavaScript 字符串编码

**IP 访问控制**
- 黑白名单管理
- 支持 CIDR 范围
- 管理端点配置

**API 签名验证**
- HMAC-SHA256 签名
- 时间戳验证 (防重放)
- Nonce 唯一性验证

### 4. 缓存策略

**Redis 多级缓存**
- 普通缓存 (get/set)
- Tag 缓存 (按标签清理)
- Version 缓存 (版本控制)
- Null 缓存 (防止缓存穿透)

**缓存防护**
- 缓存穿透 (Null Caching)
- 缓存击穿 (Double Check Lock)
- 缓存雪崩 (Random TTL)

### 5. 日志与监控

**日志系统**
- 结构化日志 (Pino)
- Loki 集成 (生产环境)
- 追踪信息 (traceId, userId, requestId)
- 多种日志级别

**健康检查**
- 详细健康检查 (/health)
- 存活检查 (/health/live)
- 就绪检查 (/health/ready)

### 6. 定时任务

**清理任务**
- 清理过期会话 (每天凌晨 2 点)
- 清理过期验证码 (每小时)
- 清理过期 Token (每天凌晨 3 点)
- 清理软删除数据 (每天凌晨 4 点，90 天)

### 7. 数据处理

**数据脱敏**
- 用户密码
- 敏感信息
- API 响应过滤

**字段转换**
- 日期格式化
- 布尔值转换
- 数字格式化

**错误处理**
- 统一错误响应格式
- 自定义错误类型
- Zod 验证错误处理

## 性能优化

### 1. 数据库优化
- Drizzle ORM 类型安全查询
- 索引优化
- 连接池管理
- 事务支持

### 2. 缓存优化
- Redis 高速缓存
- 多级缓存策略
- 缓存防护机制

### 3. 异步处理
- 异步任务处理
- 非阻塞 I/O

### 4. 图片处理
- Sharp 图片压缩
- 自动调整尺寸
- 格式转换

## 开发与部署

### 开发工具
- TypeScript: 类型安全
- Bun: JavaScript 运行时
- ESLint: 代码检查
- Prettier: 代码格式化

### 测试
- 单元测试 (Bun Test)
- 集成测试
- 覆盖率报告

### 部署
- Docker 容器化
- Docker Compose 本地开发
- GitHub Actions CI/CD

## 代码质量

### 1. 类型安全
- tRPC 前后端类型共享
- Drizzle ORM 数据库类型安全
- Zod 运行时数据验证
- TypeScript 编译时检查

### 2. 代码规范
- ESLint 代码检查
- Prettier 代码格式化
- Husky Git Hooks
- Lint-staged 暂存文件检查

### 3. 文档
- API 文档 (tRPC Panel)
- 架构文档
- 功能文档
- 安全文档

## 扩展性

### 1. 水平扩展
- 无状态设计
- Redis 共享会话
- 负载均衡支持

### 2. 垂直扩展
- 连接池优化
- 缓存策略优化
- 数据库分库分表准备

### 3. 功能扩展
- 插件化设计
- 中间件机制
- 路由模块化

## 安全性

### 1. 认证安全
- JWT Token
- Session 管理
- OAuth 集成
- 设备指纹识别

### 2. 数据安全
- 密码加密 (bcrypt)
- 数据脱敏
- SQL 注入防护
- XSS 防护

### 3. 访问控制
- RBAC 权限模型
- IP 黑白名单
- API 签名验证
- 请求限流

### 4. 审计日志
- 用户操作日志
- API 请求日志
- 数据库操作日志

## 运维友好

### 1. 可观测性
- 结构化日志
- 健康检查
- 性能监控
- 错误追踪

### 2. 可维护性
- 模块化设计
- 清晰的代码结构
- 完善的文档
- 单元测试覆盖

### 3. 可部署性
- Docker 容器化
- 环境变量配置
- 自动化 CI/CD
- 滚动更新支持

## 总结

面试后端系统架构具有以下特点：

1. **类型安全**: 从数据库到前端全链路类型安全
2. **高性能**: Fastify + Redis 缓存优化
3. **安全可靠**: 多层安全防护体系
4. **易扩展**: 模块化设计，便于功能扩展
5. **开发友好**: 现代化开发工具链
6. **运维友好**: 完善的监控和日志系统

系统已实现的核心功能包括认证授权、题库管理、题目管理、社区功能、文件上传等，具备生产环境部署能力。