# æ•°æ®åº“äº‹åŠ¡å’Œå®šæ—¶ä»»åŠ¡å®æ–½è®¡åˆ’

## é¡¹ç›®æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è§„åˆ’é¢è¯•åï¼ˆmianshihouï¼‰é¡¹ç›®ä¸­æ•°æ®åº“äº‹åŠ¡å¤„ç†å’Œå®šæ—¶ä»»åŠ¡æ¸…ç†æ•°æ®çš„å®æ–½æ–¹æ¡ˆã€‚

**å®æ–½æ—¶é—´**: 2026å¹´1æœˆ
**æŠ€æœ¯æ ˆ**: Drizzle ORM, PostgreSQL, Bun, node-cron

---

## ä¸€ã€æ•°æ®åº“äº‹åŠ¡å¤„ç†

### 1.1 éœ€æ±‚åˆ†æ

#### ä¸ºä»€ä¹ˆéœ€è¦äº‹åŠ¡ï¼Ÿ

å½“å‰é¡¹ç›®ä¸­å­˜åœ¨å¤šä¸ªéœ€è¦åŸå­æ€§æ“ä½œçš„åœºæ™¯ï¼š

1. **é¢˜åº“æ·»åŠ é¢˜ç›®** (`addQuestion`)
   - æ£€æŸ¥é¢˜åº“æ˜¯å¦å­˜åœ¨
   - æ£€æŸ¥é¢˜ç›®æ˜¯å¦å­˜åœ¨
   - æ£€æŸ¥æ˜¯å¦å·²å…³è”
   - æ·»åŠ å…³è”è®°å½•
   - æ›´æ–°é¢˜åº“é¢˜ç›®æ•°é‡

2. **é¢˜åº“ç§»é™¤é¢˜ç›®** (`removeQuestion`)
   - æ£€æŸ¥å…³è”æ˜¯å¦å­˜åœ¨
   - åˆ é™¤å…³è”è®°å½•
   - æ›´æ–°é¢˜åº“é¢˜ç›®æ•°é‡

3. **å¸–å­ç‚¹èµ/å–æ¶ˆç‚¹èµ**
   - æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ
   - æ·»åŠ /åˆ é™¤ç‚¹èµè®°å½•
   - æ›´æ–°å¸–å­ç‚¹èµæ•°

4. **å¸–å­æ”¶è—/å–æ¶ˆæ”¶è—**
   - æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
   - æ·»åŠ /åˆ é™¤æ”¶è—è®°å½•
   - æ›´æ–°å¸–å­æ”¶è—æ•°

#### å½“å‰é—®é¢˜

ä¸Šè¿°æ“ä½œå¦‚æœä¸­é€”å¤±è´¥ï¼Œä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼š
- å…³è”è®°å½•å·²æ·»åŠ ï¼Œä½†è®¡æ•°å™¨æœªæ›´æ–°
- è®¡æ•°å™¨å·²æ›´æ–°ï¼Œä½†å…³è”è®°å½•æœªæ·»åŠ 
- å¤šä¸ªå¹¶å‘è¯·æ±‚å¯èƒ½å¯¼è‡´è®¡æ•°å™¨é”™è¯¯

### 1.2 æŠ€æœ¯æ–¹æ¡ˆ

#### æ–¹æ¡ˆé€‰æ‹©ï¼šDrizzle ORM äº‹åŠ¡

Drizzle ORM æä¾›äº†åŸç”Ÿçš„äº‹åŠ¡æ”¯æŒï¼š

```typescript
import { db } from './index';

// ä½¿ç”¨äº‹åŠ¡
await db.transaction(async (tx) => {
  // æ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­æ‰§è¡Œ
  await tx.insert(table1).values(...);
  await tx.update(table2).set(...);

  // å¦‚æœæŠ›å‡ºå¼‚å¸¸ï¼Œäº‹åŠ¡ä¼šè‡ªåŠ¨å›æ»š
  // å¦‚æœæ­£å¸¸è¿”å›ï¼Œäº‹åŠ¡ä¼šè‡ªåŠ¨æäº¤
});
```

#### ä¼˜åŠ¿

1. **åŸç”Ÿæ”¯æŒ**: Drizzle ORM å†…ç½®äº‹åŠ¡æ”¯æŒï¼Œæ— éœ€é¢å¤–ä¾èµ–
2. **ç±»å‹å®‰å…¨**: TypeScript ç±»å‹æ£€æŸ¥å®Œæ•´
3. **è‡ªåŠ¨å›æ»š**: å¼‚å¸¸æ—¶è‡ªåŠ¨å›æ»šï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†
4. **åµŒå¥—äº‹åŠ¡**: æ”¯æŒåµŒå¥—äº‹åŠ¡ï¼ˆä¿å­˜ç‚¹ï¼‰

### 1.3 å®æ–½è®¡åˆ’

#### é˜¶æ®µä¸€ï¼šåˆ›å»ºäº‹åŠ¡å·¥å…·ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

**ç›®æ ‡**: åˆ›å»ºç»Ÿä¸€çš„äº‹åŠ¡å¤„ç†å·¥å…·

**æ–‡ä»¶**: `mianshihou/apps/api/lib/transaction.ts`

**åŠŸèƒ½**:
1. `withTransaction()` - åŒ…è£…æ“ä½œåœ¨äº‹åŠ¡ä¸­æ‰§è¡Œ
2. `TransactionContext` - äº‹åŠ¡ä¸Šä¸‹æ–‡ç±»å‹
3. äº‹åŠ¡é”™è¯¯å¤„ç†

**ä»£ç ç»“æ„**:
```typescript
import { db } from '../index';

export interface TransactionContext {
  tx: Transaction;
  logger: Logger;
}

export async function withTransaction<T>(
  operation: (ctx: TransactionContext) => Promise<T>,
  options?: {
    logger?: Logger;
    operationName?: string;
  }
): Promise<T> {
  const logger = options?.logger || console;
  const operationName = options?.operationName || 'transaction';

  logger.info({ operationName }, 'äº‹åŠ¡å¼€å§‹');

  try {
    const result = await db.transaction(async (tx) => {
      return await operation({ tx, logger });
    });

    logger.info({ operationName }, 'äº‹åŠ¡æäº¤æˆåŠŸ');
    return result;
  } catch (error) {
    logger.error({ operationName, error }, 'äº‹åŠ¡å›æ»š');
    throw error;
  }
}
```

#### é˜¶æ®µäºŒï¼šæ”¹é€ é¢˜åº“æ¥å£ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

**ç›®æ ‡**: ä½¿ç”¨äº‹åŠ¡é‡æ„é¢˜åº“ç›¸å…³æ¥å£

**æ–‡ä»¶**: `mianshihou/apps/api/trpc/router/questionBank.ts`

**æ”¹é€ æ¥å£**:
1. `addQuestion` - æ·»åŠ é¢˜ç›®åˆ°é¢˜åº“
2. `removeQuestion` - ä»é¢˜åº“ç§»é™¤é¢˜ç›®

**æ”¹é€ ç¤ºä¾‹**:
```typescript
addQuestion: publicProcedure
  .input(z.object({
    questionBankId: z.number(),
    questionId: z.number(),
    userId: z.string(),
  }))
  .mutation(async ({ ctx, input }) => {
    return withTransaction(
      async ({ tx, logger }) => {
        // æ£€æŸ¥é¢˜åº“æ˜¯å¦å­˜åœ¨
        const [questionBank] = await tx
          .select()
          .from(questionBanks)
          .where(
            and(eq(questionBanks.id, input.questionBankId), eq(questionBanks.isDelete, false))
          )
          .limit(1);

        throwIfNull(questionBank, ErrorType.RESOURCE_NOT_FOUND, undefined, {
          questionBankId: input.questionBankId,
        });

        // æ£€æŸ¥é¢˜ç›®æ˜¯å¦å­˜åœ¨
        const [question] = await tx
          .select()
          .from(questions)
          .where(and(eq(questions.id, input.questionId), eq(questions.isDelete, false)))
          .limit(1);

        throwIfNull(question, ErrorType.RESOURCE_NOT_FOUND, undefined, {
          questionId: input.questionId,
        });

        // æ£€æŸ¥æ˜¯å¦å·²ç»å…³è”
        const [existingRelation] = await tx
          .select()
          .from(questionBankQuestions)
          .where(
            and(
              eq(questionBankQuestions.questionBankId, input.questionBankId),
              eq(questionBankQuestions.questionId, input.questionId)
            )
          )
          .limit(1);

        throwIf(!!existingRelation, ErrorType.DUPLICATE_OPERATION, 'é¢˜ç›®å·²åœ¨è¯¥é¢˜åº“ä¸­');

        // æ·»åŠ å…³è”
        const [newRelation] = await tx
          .insert(questionBankQuestions)
          .values({
            questionBankId: input.questionBankId,
            questionId: input.questionId,
            userId: input.userId,
          })
          .returning();

        // æ›´æ–°é¢˜åº“çš„é¢˜ç›®æ•°é‡
        await tx
          .update(questionBanks)
          .set({
            questionCount: sql`${questionBanks.questionCount} + 1`,
            updateTime: new Date(),
          })
          .where(eq(questionBanks.id, input.questionBankId));

        return newRelation;
      },
      { logger: ctx.logger, operationName: 'addQuestion' }
    );
  }),
```

#### é˜¶æ®µä¸‰ï¼šæ”¹é€ å¸–å­æ¥å£ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

**ç›®æ ‡**: ä½¿ç”¨äº‹åŠ¡é‡æ„å¸–å­ç›¸å…³æ¥å£

**æ–‡ä»¶**: `mianshihou/apps/api/trpc/router/postThumb.ts`, `postFavour.ts`

**æ”¹é€ æ¥å£**:
1. `create` - ç‚¹èµå¸–å­
2. `delete` - å–æ¶ˆç‚¹èµ
3. `create` - æ”¶è—å¸–å­
4. `delete` - å–æ¶ˆæ”¶è—

**æ”¹é€ ç¤ºä¾‹**:
```typescript
create: publicProcedure
  .input(z.object({
    postId: z.number(),
    userId: z.string(),
  }))
  .mutation(async ({ ctx, input }) => {
    return withTransaction(
      async ({ tx, logger }) => {
        // æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ
        const [existing] = await tx
          .select()
          .from(postThumbs)
          .where(
            and(
              eq(postThumbs.postId, input.postId),
              eq(postThumbs.userId, input.userId)
            )
          )
          .limit(1);

        throwIf(!!existing, ErrorType.DUPLICATE_OPERATION, 'å·²ç»ç‚¹èµè¿‡äº†');

        // æ·»åŠ ç‚¹èµè®°å½•
        const [thumb] = await tx
          .insert(postThumbs)
          .values({
            postId: input.postId,
            userId: input.userId,
          })
          .returning();

        // æ›´æ–°å¸–å­ç‚¹èµæ•°
        await tx
          .update(posts)
          .set({
            thumbNum: sql`${posts.thumbNum} + 1`,
            updateTime: new Date(),
          })
          .where(eq(posts.id, input.postId));

        return thumb;
      },
      { logger: ctx.logger, operationName: 'createPostThumb' }
    );
  }),
```

#### é˜¶æ®µå››ï¼šæµ‹è¯•å’ŒéªŒè¯ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

**ç›®æ ‡**: ç¡®ä¿äº‹åŠ¡æ­£ç¡®å·¥ä½œ

**æµ‹è¯•æ–‡ä»¶**: `mianshihou/apps/api/tests/unit/transaction.test.ts`

**æµ‹è¯•ç”¨ä¾‹**:
1. âœ… æ­£å¸¸æäº¤äº‹åŠ¡
2. âœ… å¼‚å¸¸æ—¶è‡ªåŠ¨å›æ»š
3. âœ… å¹¶å‘äº‹åŠ¡éš”ç¦»
4. âœ… åµŒå¥—äº‹åŠ¡æ”¯æŒ
5. âœ… äº‹åŠ¡è¶…æ—¶å¤„ç†

**æµ‹è¯•ç¤ºä¾‹**:
```typescript
describe('Transaction Utils', () => {
  it('should commit transaction on success', async () => {
    const result = await withTransaction(async ({ tx }) => {
      await tx.insert(questionBanks).values({ title: 'Test', userId: 'test' });
      return { success: true };
    });

    expect(result.success).toBe(true);
  });

  it('should rollback transaction on error', async () => {
    try {
      await withTransaction(async ({ tx }) => {
        await tx.insert(questionBanks).values({ title: 'Test', userId: 'test' });
        throw new Error('Rollback test');
      });
    } catch (error) {
      // éªŒè¯æ•°æ®æœªæ’å…¥
      const banks = await db.select().from(questionBanks);
      expect(banks.length).toBe(0);
    }
  });
});
```

### 1.4 é¢„æœŸæ”¶ç›Š

1. **æ•°æ®ä¸€è‡´æ€§**: ä¿è¯å¤šæ­¥éª¤æ“ä½œçš„åŸå­æ€§
2. **é”™è¯¯æ¢å¤**: è‡ªåŠ¨å›æ»šå¤±è´¥çš„æ“ä½œ
3. **å¹¶å‘å®‰å…¨**: é¿å…å¹¶å‘è¯·æ±‚å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´
4. **ä»£ç è´¨é‡**: ç»Ÿä¸€çš„äº‹åŠ¡å¤„ç†æ¨¡å¼

---

## äºŒã€å®šæ—¶ä»»åŠ¡æ¸…ç†æ•°æ®

### 2.1 éœ€æ±‚åˆ†æ

#### éœ€è¦æ¸…ç†çš„æ•°æ®ç±»å‹

1. **è¿‡æœŸçš„ä¼šè¯æ•°æ®**
   - Better-Auth çš„ session è¡¨
   - è¿‡æœŸæ—¶é—´å­—æ®µ: `expiresAt`

2. **è½¯åˆ é™¤çš„æ•°æ®**
   - æ ‡è®°ä¸º `isDelete = true` çš„æ•°æ®
   - åŒ…æ‹¬: posts, questions, questionBanks, users

3. **è¿‡æœŸçš„éªŒè¯ç **
   - verification è¡¨
   - è¿‡æœŸæ—¶é—´å­—æ®µ: `expiresAt`

4. **è¿‡æœŸçš„ OAuth Token**
   - account è¡¨
   - è¿‡æœŸæ—¶é—´å­—æ®µ: `accessTokenExpiresAt`, `refreshTokenExpiresAt`

5. **è¿‡æœŸçš„æ—¥å¿—æ•°æ®**ï¼ˆå¯é€‰ï¼‰
   - å¦‚æœæœ‰æ—¥å¿—è¡¨ï¼Œæ¸…ç†å†å²æ—¥å¿—

#### æ¸…ç†ç­–ç•¥

1. **ä¼šè¯æ¸…ç†**: æ¯å¤©æ¸…ç†ä¸€æ¬¡ï¼Œåˆ é™¤è¶…è¿‡ 30 å¤©çš„è¿‡æœŸä¼šè¯
2. **è½¯åˆ é™¤æ¸…ç†**: æ¯å‘¨æ¸…ç†ä¸€æ¬¡ï¼Œåˆ é™¤è¶…è¿‡ 90 å¤©çš„è½¯åˆ é™¤æ•°æ®
3. **éªŒè¯ç æ¸…ç†**: æ¯å°æ—¶æ¸…ç†ä¸€æ¬¡ï¼Œåˆ é™¤è¿‡æœŸçš„éªŒè¯ç 
4. **Tokenæ¸…ç†**: æ¯å¤©æ¸…ç†ä¸€æ¬¡ï¼Œåˆ é™¤è¿‡æœŸçš„ Token
5. **æ—¥å¿—æ¸…ç†**: æ¯æœˆæ¸…ç†ä¸€æ¬¡ï¼Œåˆ é™¤è¶…è¿‡ 6 ä¸ªæœˆçš„æ—¥å¿—

### 2.2 æŠ€æœ¯æ–¹æ¡ˆ

#### æ–¹æ¡ˆé€‰æ‹©ï¼šnode-cron

é€‰æ‹© `node-cron` ä½œä¸ºå®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨ï¼ŒåŸå› ï¼š
1. **è½»é‡çº§**: æ— éœ€é¢å¤–æœåŠ¡ï¼Œä»£ç å†…è¿è¡Œ
2. **çµæ´»**: æ”¯æŒæ ‡å‡†çš„ cron è¡¨è¾¾å¼
3. **ç¨³å®š**: æˆç†Ÿçš„ npm åŒ…ï¼Œå¹¿æ³›ä½¿ç”¨
4. **å…¼å®¹**: ä¸ Bun è¿è¡Œæ—¶å…¼å®¹

**å®‰è£…**:
```bash
cd mianshihou/apps/api
bun add node-cron
bun add -d @types/node-cron
```

#### ä»£ç ç»“æ„

```
mianshihou/apps/api/
â”œâ”€â”€ tasks/
â”‚   â”œâ”€â”€ index.ts           # ä»»åŠ¡è°ƒåº¦å…¥å£
â”‚   â”œâ”€â”€ cleanup/
â”‚   â”‚   â”œâ”€â”€ index.ts       # æ¸…ç†ä»»åŠ¡å¯¼å‡º
â”‚   â”‚   â”œâ”€â”€ sessions.ts    # æ¸…ç†ä¼šè¯
â”‚   â”‚   â”œâ”€â”€ soft-delete.ts # æ¸…ç†è½¯åˆ é™¤æ•°æ®
â”‚   â”‚   â”œâ”€â”€ verification.ts# æ¸…ç†éªŒè¯ç 
â”‚   â”‚   â””â”€â”€ tokens.ts      # æ¸…ç†è¿‡æœŸçš„ Token
â”‚   â””â”€â”€ cleanup-schedule.ts # å®šæ—¶ä»»åŠ¡é…ç½®
â””â”€â”€ server.ts              # æœåŠ¡å¯åŠ¨æ—¶æ³¨å†Œä»»åŠ¡
```

### 2.3 å®æ–½è®¡åˆ’

#### é˜¶æ®µä¸€ï¼šåˆ›å»ºä»»åŠ¡æ¡†æ¶ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

**ç›®æ ‡**: åˆ›å»ºå®šæ—¶ä»»åŠ¡çš„åŸºç¡€æ¡†æ¶

**æ–‡ä»¶**: `mianshihou/apps/api/tasks/cleanup-schedule.ts`

**åŠŸèƒ½**:
1. å®šä¹‰æ‰€æœ‰æ¸…ç†ä»»åŠ¡
2. é…ç½®æ‰§è¡Œæ—¶é—´
3. æä¾›ä»»åŠ¡å¯åŠ¨/åœæ­¢æ¥å£

**ä»£ç ç»“æ„**:
```typescript
import cron from 'node-cron';
import { cleanupExpiredSessions } from './cleanup/sessions';
import { cleanupSoftDeletedData } from './cleanup/soft-delete';
import { cleanupExpiredVerifications } from './cleanup/verification';
import { cleanupExpiredTokens } from './cleanup/tokens';

// ä»»åŠ¡é…ç½®
const cleanupTasks = [
  {
    name: 'cleanupExpiredSessions',
    cronExpression: '0 2 * * *', // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    task: cleanupExpiredSessions,
  },
  {
    name: 'cleanupSoftDeletedData',
    cronExpression: '0 3 * * 0', // æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹æ‰§è¡Œ
    task: cleanupSoftDeletedData,
  },
  {
    name: 'cleanupExpiredVerifications',
    cronExpression: '0 * * * *', // æ¯å°æ—¶æ‰§è¡Œ
    task: cleanupExpiredVerifications,
  },
  {
    name: 'cleanupExpiredTokens',
    cronExpression: '0 4 * * *', // æ¯å¤©å‡Œæ™¨4ç‚¹æ‰§è¡Œ
    task: cleanupExpiredTokens,
  },
];

// å­˜å‚¨å®šæ—¶ä»»åŠ¡å¼•ç”¨
const scheduledTasks = new Map<string, cron.ScheduledTask>();

// å¯åŠ¨æ‰€æœ‰ä»»åŠ¡
export function startCleanupTasks() {
  console.log('å¯åŠ¨æ¸…ç†ä»»åŠ¡...');

  cleanupTasks.forEach(({ name, cronExpression, task }) => {
    const scheduledTask = cron.schedule(cronExpression, async () => {
      console.log(`å¼€å§‹æ‰§è¡Œæ¸…ç†ä»»åŠ¡: ${name}`);
      try {
        await task();
        console.log(`æ¸…ç†ä»»åŠ¡å®Œæˆ: ${name}`);
      } catch (error) {
        console.error(`æ¸…ç†ä»»åŠ¡å¤±è´¥: ${name}`, error);
      }
    });

    scheduledTasks.set(name, scheduledTask);
    console.log(`å·²æ³¨å†Œæ¸…ç†ä»»åŠ¡: ${name} (${cronExpression})`);
  });

  console.log('æ‰€æœ‰æ¸…ç†ä»»åŠ¡å·²å¯åŠ¨');
}

// åœæ­¢æ‰€æœ‰ä»»åŠ¡
export function stopCleanupTasks() {
  console.log('åœæ­¢æ¸…ç†ä»»åŠ¡...');

  scheduledTasks.forEach((task, name) => {
    task.stop();
    console.log(`å·²åœæ­¢æ¸…ç†ä»»åŠ¡: ${name}`);
  });

  scheduledTasks.clear();
  console.log('æ‰€æœ‰æ¸…ç†ä»»åŠ¡å·²åœæ­¢');
}

// æ‰‹åŠ¨è§¦å‘ä»»åŠ¡ï¼ˆç”¨äºæµ‹è¯•ï¼‰
export async function runCleanupTask(taskName: string) {
  const taskConfig = cleanupTasks.find(t => t.name === taskName);

  if (!taskConfig) {
    throw new Error(`æœªæ‰¾åˆ°æ¸…ç†ä»»åŠ¡: ${taskName}`);
  }

  console.log(`æ‰‹åŠ¨æ‰§è¡Œæ¸…ç†ä»»åŠ¡: ${taskName}`);
  await taskConfig.task();
  console.log(`æ¸…ç†ä»»åŠ¡å®Œæˆ: ${taskName}`);
}
```

#### é˜¶æ®µäºŒï¼šå®ç°æ¸…ç†ä»»åŠ¡ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

##### ä»»åŠ¡1: æ¸…ç†è¿‡æœŸä¼šè¯

**æ–‡ä»¶**: `mianshihou/apps/api/tasks/cleanup/sessions.ts`

**åŠŸèƒ½**: åˆ é™¤è¿‡æœŸçš„ Better-Auth ä¼šè¯

**ä»£ç **:
```typescript
import { db } from '../../index';
import { sessions } from '../../db/schema';
import { lt, and } from 'drizzle-orm';

/**
 * æ¸…ç†è¿‡æœŸçš„ä¼šè¯æ•°æ®
 * åˆ é™¤ expiresAt å°äºå½“å‰æ—¶é—´çš„ä¼šè¯
 */
export async function cleanupExpiredSessions() {
  console.log('å¼€å§‹æ¸…ç†è¿‡æœŸä¼šè¯...');

  const now = new Date();

  const result = await db
    .delete(sessions)
    .where(lt(sessions.expiresAt, now))
    .returning();

  console.log(`æ¸…ç†äº† ${result.length} ä¸ªè¿‡æœŸä¼šè¯`);

  return {
    deletedCount: result.length,
    timestamp: now,
  };
}
```

##### ä»»åŠ¡2: æ¸…ç†è½¯åˆ é™¤æ•°æ®

**æ–‡ä»¶**: `mianshihou/apps/api/tasks/cleanup/soft-delete.ts`

**åŠŸèƒ½**: æ¸…ç†è¶…è¿‡ 90 å¤©çš„è½¯åˆ é™¤æ•°æ®

**ä»£ç **:
```typescript
import { db } from '../../index';
import { posts, questions, questionBanks, users } from '../../db/schema';
import { eq, and, lt } from 'drizzle-orm';

/**
 * æ¸…ç†è¶…è¿‡ 90 å¤©çš„è½¯åˆ é™¤æ•°æ®
 */
export async function cleanupSoftDeletedData() {
  console.log('å¼€å§‹æ¸…ç†è½¯åˆ é™¤æ•°æ®...');

  const ninetyDaysAgo = new Date();
  ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);

  let totalDeleted = 0;

  // æ¸…ç†å¸–å­
  const deletedPosts = await db
    .delete(posts)
    .where(
      and(
        eq(posts.isDelete, true),
        lt(posts.updateTime, ninetyDaysAgo)
      )
    )
    .returning();

  totalDeleted += deletedPosts.length;
  console.log(`æ¸…ç†äº† ${deletedPosts.length} ä¸ªè½¯åˆ é™¤çš„å¸–å­`);

  // æ¸…ç†é¢˜ç›®
  const deletedQuestions = await db
    .delete(questions)
    .where(
      and(
        eq(questions.isDelete, true),
        lt(questions.updateTime, ninetyDaysAgo)
      )
    )
    .returning();

  totalDeleted += deletedQuestions.length;
  console.log(`æ¸…ç†äº† ${deletedQuestions.length} ä¸ªè½¯åˆ é™¤çš„é¢˜ç›®`);

  // æ¸…ç†é¢˜åº“
  const deletedBanks = await db
    .delete(questionBanks)
    .where(
      and(
        eq(questionBanks.isDelete, true),
        lt(questionBanks.updateTime, ninetyDaysAgo)
      )
    )
    .returning();

  totalDeleted += deletedBanks.length;
  console.log(`æ¸…ç†äº† ${deletedBanks.length} ä¸ªè½¯åˆ é™¤çš„é¢˜åº“`);

  // æ³¨æ„ï¼šé€šå¸¸ä¸åˆ é™¤ç”¨æˆ·ï¼Œä¿ç•™ç”¨æˆ·è®°å½•ç”¨äºå†å²è¿½æº¯
  console.log('æ¸…ç†è½¯åˆ é™¤æ•°æ®å®Œæˆ');

  return {
    postsDeleted: deletedPosts.length,
    questionsDeleted: deletedQuestions.length,
    banksDeleted: deletedBanks.length,
    totalDeleted,
    timestamp: new Date(),
  };
}
```

##### ä»»åŠ¡3: æ¸…ç†è¿‡æœŸéªŒè¯ç 

**æ–‡ä»¶**: `mianshihou/apps/api/tasks/cleanup/verification.ts`

**åŠŸèƒ½**: åˆ é™¤è¿‡æœŸçš„éªŒè¯ç 

**ä»£ç **:
```typescript
import { db } from '../../index';
import { verifications } from '../../db/schema';
import { lt } from 'drizzle-orm';

/**
 * æ¸…ç†è¿‡æœŸçš„éªŒè¯ç 
 */
export async function cleanupExpiredVerifications() {
  console.log('å¼€å§‹æ¸…ç†è¿‡æœŸéªŒè¯ç ...');

  const now = new Date();

  const result = await db
    .delete(verifications)
    .where(lt(verifications.expiresAt, now))
    .returning();

  console.log(`æ¸…ç†äº† ${result.length} ä¸ªè¿‡æœŸéªŒè¯ç `);

  return {
    deletedCount: result.length,
    timestamp: now,
  };
}
```

##### ä»»åŠ¡4: æ¸…ç†è¿‡æœŸToken

**æ–‡ä»¶**: `mianshihou/apps/api/tasks/cleanup/tokens.ts`

**åŠŸèƒ½**: æ¸…ç†è¿‡æœŸçš„ OAuth Token

**ä»£ç **:
```typescript
import { db } from '../../index';
import { accounts } from '../../db/schema';
import { lt, sql } from 'drizzle-orm';

/**
 * æ¸…ç†è¿‡æœŸçš„ OAuth Token
 * åˆ é™¤è®¿é—®ä»¤ç‰Œå’Œåˆ·æ–°ä»¤ç‰Œéƒ½å·²è¿‡æœŸçš„è´¦æˆ·
 */
export async function cleanupExpiredTokens() {
  console.log('å¼€å§‹æ¸…ç†è¿‡æœŸToken...');

  const now = new Date();

  // åˆ é™¤ä¸¤ç§ token éƒ½å·²è¿‡æœŸçš„è´¦æˆ·
  const result = await db
    .delete(accounts)
    .where(
      sql`${accounts.accessTokenExpiresAt} < ${now} AND ${accounts.refreshTokenExpiresAt} < ${now}`
    )
    .returning();

  console.log(`æ¸…ç†äº† ${result.length} ä¸ªè¿‡æœŸçš„Tokenè´¦æˆ·`);

  return {
    deletedCount: result.length,
    timestamp: now,
  };
}
```

#### é˜¶æ®µä¸‰ï¼šé›†æˆåˆ°æœåŠ¡å¯åŠ¨ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

**ç›®æ ‡**: åœ¨æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨å®šæ—¶ä»»åŠ¡

**æ–‡ä»¶**: `mianshihou/apps/api/server.ts`

**ä¿®æ”¹**:
```typescript
import { startCleanupTasks, stopCleanupTasks } from './tasks/cleanup-schedule';

async function startServer() {
  try {
    // å¯åŠ¨æ¸…ç†ä»»åŠ¡
    startCleanupTasks();

    // å¯åŠ¨ HTTP æœåŠ¡å™¨
    await fastify.listen({ port: 3001, host: '0.0.0.0' });
    console.log('ğŸš€ Server ready at http://localhost:3001');
  } catch (err) {
    fastify.log.error(err);
    process.exit(1);
  }
}

// ä¼˜é›…å…³é—­
process.on('SIGTERM', async () => {
  console.log('SIGTERM signal received: closing HTTP server');
  await fastify.close();
  stopCleanupTasks();
  process.exit(0);
});

process.on('SIGINT', async () => {
  console.log('SIGINT signal received: closing HTTP server');
  await fastify.close();
  stopCleanupTasks();
  process.exit(0);
});

startServer();
```

#### é˜¶æ®µå››ï¼šæ·»åŠ ç®¡ç†æ¥å£ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

**ç›®æ ‡**: æä¾›ç®¡ç†æ¥å£æ‰‹åŠ¨è§¦å‘æ¸…ç†ä»»åŠ¡

**æ–‡ä»¶**: `mianshihou/apps/api/trpc/router/admin.ts`

**åŠŸèƒ½**:
1. æ‰‹åŠ¨è§¦å‘æ¸…ç†ä»»åŠ¡
2. æŸ¥çœ‹æ¸…ç†ä»»åŠ¡çŠ¶æ€
3. ä¿®æ”¹æ¸…ç†ä»»åŠ¡é…ç½®

**ä»£ç **:
```typescript
import { router, publicProcedure } from '../index';
import { z } from 'zod';
import { runCleanupTask } from '../../tasks/cleanup-schedule';

export const adminRouter = router({
  cleanupTasks: router({
    runTask: publicProcedure
      .input(z.object({
        taskName: z.enum([
          'cleanupExpiredSessions',
          'cleanupSoftDeletedData',
          'cleanupExpiredVerifications',
          'cleanupExpiredTokens',
        ]),
      }))
      .mutation(async ({ ctx, input }) => {
        ctx.logger.info({ taskName: input.taskName }, 'æ‰‹åŠ¨æ‰§è¡Œæ¸…ç†ä»»åŠ¡');

        const result = await runCleanupTask(input.taskName);

        ctx.logger.info({ taskName: input.taskName, result }, 'æ¸…ç†ä»»åŠ¡å®Œæˆ');

        return success(result, 'æ¸…ç†ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ');
      }),

    listTasks: publicProcedure.query(async ({ ctx }) => {
      return success([
        { name: 'cleanupExpiredSessions', description: 'æ¸…ç†è¿‡æœŸä¼šè¯', cron: '0 2 * * *' },
        { name: 'cleanupSoftDeletedData', description: 'æ¸…ç†è½¯åˆ é™¤æ•°æ®', cron: '0 3 * * 0' },
        { name: 'cleanupExpiredVerifications', description: 'æ¸…ç†è¿‡æœŸéªŒè¯ç ', cron: '0 * * * *' },
        { name: 'cleanupExpiredTokens', description: 'æ¸…ç†è¿‡æœŸToken', cron: '0 4 * * *' },
      ], 'è·å–æ¸…ç†ä»»åŠ¡åˆ—è¡¨æˆåŠŸ');
    }),
  }),
});
```

#### é˜¶æ®µäº”ï¼šæµ‹è¯•å’ŒéªŒè¯ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

**ç›®æ ‡**: ç¡®ä¿æ¸…ç†ä»»åŠ¡æ­£ç¡®å·¥ä½œ

**æµ‹è¯•æ–‡ä»¶**: `mianshihou/apps/api/tests/unit/cleanup-tasks.test.ts`

**æµ‹è¯•ç”¨ä¾‹**:
1. âœ… æ¸…ç†è¿‡æœŸä¼šè¯
2. âœ… æ¸…ç†è½¯åˆ é™¤æ•°æ®
3. âœ… æ¸…ç†è¿‡æœŸéªŒè¯ç 
4. âœ… æ¸…ç†è¿‡æœŸToken
5. âœ… ä»»åŠ¡è°ƒåº¦æ­£å¸¸å·¥ä½œ
6. âœ… ä¼˜é›…å…³é—­æ—¶åœæ­¢ä»»åŠ¡

**æµ‹è¯•ç¤ºä¾‹**:
```typescript
describe('Cleanup Tasks', () => {
  it('should cleanup expired sessions', async () => {
    // åˆ›å»ºè¿‡æœŸä¼šè¯
    await db.insert(sessions).values({
      id: 'test-expired',
      userId: 'test',
      expiresAt: new Date(Date.now() - 1000 * 60 * 60),
      token: 'expired-token',
    });

    // æ‰§è¡Œæ¸…ç†
    const result = await cleanupExpiredSessions();

    // éªŒè¯
    expect(result.deletedCount).toBe(1);

    const remaining = await db.select().from(sessions);
    expect(remaining.length).toBe(0);
  });

  it('should cleanup soft deleted data older than 90 days', async () => {
    // åˆ›å»º91å¤©å‰çš„è½¯åˆ é™¤æ•°æ®
    const ninetyOneDaysAgo = new Date();
    ninetyOneDaysAgo.setDate(ninetyOneDaysAgo.getDate() - 91);

    await db.insert(posts).values({
      title: 'Test',
      content: 'Test',
      userId: 'test',
      isDelete: true,
      updateTime: ninetyOneDaysAgo,
    });

    // æ‰§è¡Œæ¸…ç†
    const result = await cleanupSoftDeletedData();

    // éªŒè¯
    expect(result.postsDeleted).toBe(1);

    const remaining = await db.select().from(posts);
    expect(remaining.length).toBe(0);
  });
});
```

### 2.4 é¢„æœŸæ”¶ç›Š

1. **æ•°æ®åº“æ€§èƒ½**: å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®ï¼Œå‡å°‘æ•°æ®åº“è´Ÿè½½
2. **å­˜å‚¨ç©ºé—´**: é‡Šæ”¾ä¸å¿…è¦çš„å­˜å‚¨ç©ºé—´
3. **æ•°æ®å®‰å…¨**: é¿å…æ•æ„Ÿæ•°æ®é•¿æœŸå­˜å‚¨
4. **ç»´æŠ¤è‡ªåŠ¨åŒ–**: è‡ªåŠ¨åŒ–æ¸…ç†ï¼Œå‡å°‘æ‰‹åŠ¨ç»´æŠ¤å·¥ä½œ

---

## ä¸‰ã€å®æ–½é¡ºåºå’Œæ—¶é—´ä¼°ç®—

### 3.1 å®æ–½é¡ºåº

#### ç¬¬ä¸€é˜¶æ®µï¼šäº‹åŠ¡å¤„ç†ï¼ˆ2-3å¤©ï¼‰
1. âœ… åˆ›å»ºäº‹åŠ¡å·¥å…· (0.5å¤©)
2. âœ… æ”¹é€ é¢˜åº“æ¥å£ (1å¤©)
3. âœ… æ”¹é€ å¸–å­æ¥å£ (1å¤©)
4. âœ… ç¼–å†™æµ‹è¯•ç”¨ä¾‹ (0.5å¤©)

#### ç¬¬äºŒé˜¶æ®µï¼šå®šæ—¶ä»»åŠ¡ï¼ˆ3-4å¤©ï¼‰
1. âœ… åˆ›å»ºä»»åŠ¡æ¡†æ¶ (0.5å¤©)
2. âœ… å®ç°æ¸…ç†ä»»åŠ¡ (1.5å¤©)
3. âœ… é›†æˆåˆ°æœåŠ¡å¯åŠ¨ (0.5å¤©)
4. âœ… æ·»åŠ ç®¡ç†æ¥å£ (0.5å¤©)
5. âœ… ç¼–å†™æµ‹è¯•ç”¨ä¾‹ (0.5å¤©)

#### ç¬¬ä¸‰é˜¶æ®µï¼šæ–‡æ¡£å’Œä¼˜åŒ–ï¼ˆ1-2å¤©ï¼‰
1. âœ… æ›´æ–°APIæ–‡æ¡£
2. âœ… ç¼–å†™è¿ç»´æ–‡æ¡£
3. âœ… æ€§èƒ½ä¼˜åŒ–
4. âœ… ä»£ç å®¡æŸ¥

### 3.2 æ€»æ—¶é—´ä¼°ç®—

- **äº‹åŠ¡å¤„ç†**: 2-3å¤©
- **å®šæ—¶ä»»åŠ¡**: 3-4å¤©
- **æ–‡æ¡£å’Œä¼˜åŒ–**: 1-2å¤©
- **æ€»è®¡**: 6-9å¤©

---

## å››ã€é£é™©è¯„ä¼°

### 4.1 äº‹åŠ¡å¤„ç†é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| äº‹åŠ¡è¶…æ—¶ | é«˜ | ä½ | è®¾ç½®åˆç†çš„äº‹åŠ¡è¶…æ—¶æ—¶é—´ |
| æ­»é” | ä¸­ | ä½ | æŒ‰å›ºå®šé¡ºåºè®¿é—®è¡¨ |
| å¹¶å‘å†²çª | ä¸­ | ä¸­ | ä½¿ç”¨ä¹è§‚é”æˆ–é‡è¯•æœºåˆ¶ |
| å›æ»šå¤±è´¥ | é«˜ | ä½ | ç›‘æ§äº‹åŠ¡æ—¥å¿— |

### 4.2 å®šæ—¶ä»»åŠ¡é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| è¯¯åˆ æ•°æ® | é«˜ | ä½ | å…ˆSELECTå†DELETEï¼Œæ·»åŠ æ—¥å¿— |
| ä»»åŠ¡é˜»å¡ | ä¸­ | ä¸­ | è®¾ç½®ä»»åŠ¡è¶…æ—¶æ—¶é—´ |
| æœåŠ¡é‡å¯æ—¶ä»»åŠ¡ä¸¢å¤± | ä½ | ä½ | æœåŠ¡é‡å¯æ—¶è‡ªåŠ¨å¯åŠ¨ä»»åŠ¡ |
| å¹¶å‘æ‰§è¡Œ | ä¸­ | ä½ | ä½¿ç”¨åˆ†å¸ƒå¼é” |

### 4.3 ç¼“è§£æªæ–½

1. **å……åˆ†æµ‹è¯•**: åœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†æµ‹è¯•åå†ä¸Šçº¿
2. **ç°åº¦å‘å¸ƒ**: å…ˆåœ¨éƒ¨åˆ†ç¯å¢ƒè¿è¡Œï¼Œè§‚å¯Ÿæ•ˆæœ
3. **ç›‘æ§å‘Šè­¦**: æ·»åŠ ç›‘æ§æŒ‡æ ‡å’Œå‘Šè­¦æœºåˆ¶
4. **å¤‡ä»½æ¢å¤**: é‡è¦æ“ä½œå‰å¤‡ä»½æ•°æ®
5. **å›æ»šæ–¹æ¡ˆ**: å‡†å¤‡å¿«é€Ÿå›æ»šæ–¹æ¡ˆ

---

## äº”ã€åç»­ä¼˜åŒ–

### 5.1 äº‹åŠ¡å¤„ç†ä¼˜åŒ–

1. **åˆ†å¸ƒå¼äº‹åŠ¡**: å¦‚æœæœªæ¥éœ€è¦è·¨æœåŠ¡äº‹åŠ¡ï¼Œè€ƒè™‘ä½¿ç”¨ Saga æ¨¡å¼
2. **äº‹åŠ¡ç›‘æ§**: æ·»åŠ äº‹åŠ¡æ‰§è¡Œæ—¶é—´å’Œé¢‘ç‡ç›‘æ§
3. **æ€§èƒ½ä¼˜åŒ–**: å¯¹äºé«˜é¢‘æ“ä½œï¼Œè€ƒè™‘æ‰¹é‡å¤„ç†

### 5.2 å®šæ—¶ä»»åŠ¡ä¼˜åŒ–

1. **åˆ†å¸ƒå¼è°ƒåº¦**: å¦‚æœæœ‰å¤šä¸ªå®ä¾‹ï¼Œä½¿ç”¨åˆ†å¸ƒå¼è°ƒåº¦
2. **ä»»åŠ¡é˜Ÿåˆ—**: å¯¹äºè€—æ—¶ä»»åŠ¡ï¼Œä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—
3. **æ™ºèƒ½æ¸…ç†**: æ ¹æ®æ•°æ®é‡åŠ¨æ€è°ƒæ•´æ¸…ç†ç­–ç•¥
4. **æ•°æ®å½’æ¡£**: é‡è¦çš„è½¯åˆ é™¤æ•°æ®å…ˆå½’æ¡£å†åˆ é™¤

### 5.3 å…¶ä»–ä¼˜åŒ–

1. **æ—¥å¿—å¢å¼º**: æ·»åŠ è¯¦ç»†çš„æ“ä½œæ—¥å¿—
2. **æ€§èƒ½æŒ‡æ ‡**: æ·»åŠ æ€§èƒ½ç›‘æ§æŒ‡æ ‡
3. **å‘Šè­¦æœºåˆ¶**: æ·»åŠ å¼‚å¸¸å‘Šè­¦
4. **è‡ªåŠ¨åŒ–æµ‹è¯•**: æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹

---

## å…­ã€æ–‡æ¡£æ›´æ–°

### 6.1 éœ€è¦æ›´æ–°çš„æ–‡æ¡£

1. âœ… `docs/æ•°æ®åº“äº‹åŠ¡å’Œå®šæ—¶ä»»åŠ¡è®¡åˆ’.md` - æœ¬æ–‡æ¡£
2. â³ `docs/api-documentation/api-documentation.md` - æ·»åŠ ç®¡ç†æ¥å£æ–‡æ¡£
3. â³ `mianshihou/apps/api/README.md` - æ·»åŠ å®šæ—¶ä»»åŠ¡è¯´æ˜
4. â³ `docs/è¿ç»´æŒ‡å—.md` - æ·»åŠ è¿ç»´è¯´æ˜ï¼ˆæ–°å»ºï¼‰

### 6.2 éœ€è¦æ–°å»ºçš„æ–‡æ¡£

1. â³ `docs/è¿ç»´æŒ‡å—.md` - è¿ç»´æ“ä½œæŒ‡å—
2. â³ `docs/æ€§èƒ½ä¼˜åŒ–.md` - æ€§èƒ½ä¼˜åŒ–æŒ‡å—

---

## ä¸ƒã€éªŒæ”¶æ ‡å‡†

### 7.1 äº‹åŠ¡å¤„ç†éªŒæ”¶

- âœ… æ‰€æœ‰éœ€è¦äº‹åŠ¡çš„æ¥å£éƒ½ä½¿ç”¨äº†äº‹åŠ¡
- âœ… äº‹åŠ¡åœ¨å¼‚å¸¸æ—¶æ­£ç¡®å›æ»š
- âœ… å¹¶å‘è¯·æ±‚ä¸ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- âœ… é›†æˆæµ‹è¯•é€šè¿‡

### 7.2 å®šæ—¶ä»»åŠ¡éªŒæ”¶

- âœ… æ‰€æœ‰æ¸…ç†ä»»åŠ¡æŒ‰é¢„æœŸæ—¶é—´æ‰§è¡Œ
- âœ… æ¸…ç†ä»»åŠ¡æ­£ç¡®åˆ é™¤ç›®æ ‡æ•°æ®
- âœ… æ¸…ç†ä»»åŠ¡æœ‰è¯¦ç»†çš„æ—¥å¿—è®°å½•
- âœ… ç®¡ç†æ¥å£å¯ä»¥æ‰‹åŠ¨è§¦å‘ä»»åŠ¡
- âœ… æœåŠ¡é‡å¯åä»»åŠ¡è‡ªåŠ¨å¯åŠ¨
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%

---

## å…«ã€å‚è€ƒèµ„æº

### 8.1 æŠ€æœ¯æ–‡æ¡£

- [Drizzle ORM äº‹åŠ¡æ–‡æ¡£](https://orm.drizzle.team/docs/transactions)
- [node-cron æ–‡æ¡£](https://www.npmjs.com/package/node-cron)
- [PostgreSQL äº‹åŠ¡æ–‡æ¡£](https://www.postgresql.org/docs/current/transaction-iso.html)

### 8.2 æœ€ä½³å®è·µ

- [æ•°æ®åº“äº‹åŠ¡æœ€ä½³å®è·µ](https://www.postgresql.org/docs/current/transaction-iso.html)
- [å®šæ—¶ä»»åŠ¡è®¾è®¡æ¨¡å¼](https://martinfowler.com/articles/replace-cron-jobs.html)
- [æ•°æ®æ¸…ç†ç­–ç•¥](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/bp-cleanup.html)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**åˆ›å»ºæ—¥æœŸ**: 2026å¹´1æœˆ31æ—¥
**çŠ¶æ€**: ğŸ“‹ å¾…å®¡æ ¸