# 统一后端响应格式计划

## 📋 项目目标

1. **统一响应格式** - 所有接口返回一致的响应结构
2. **敏感字段过滤** - 防止敏感数据泄露到前端
3. **字段规范化** - 统一字段命名和格式

---

## 🔍 当前状态分析

### 1. 响应格式现状

#### Better-Auth Handler 接口
```json
{
  "token": "xxx",
  "user": { ... }
}
```
**问题**: 直接返回数据，没有统一的响应包装

#### tRPC 接口
```json
{
  "result": {
    "data": { ... }
  }
}
```
**问题**: tRPC 默认格式，包含嵌套的 `result.data`

#### 错误响应
```json
{
  "success": false,
  "error": { ... }
}
```
**状态**: ✅ 已统一

### 2. 敏感字段识别

#### 用户表 (users)
| 字段名 | 类型 | 是否敏感 | 说明 |
|--------|------|----------|------|
| `userPassword` | varchar | 🔴 是 | 密码哈希值 |
| `unionId` | varchar | 🟡 是 | 第三方登录唯一标识 |
| `mpOpenId` | varchar | 🟡 是 | 微信OpenID |
| `lastLoginIp` | varchar | 🟡 是 | 最后登录IP |
| `isDelete` | boolean | 🟡 是 | 软删除标记 |

#### 会话表 (sessions)
| 字段名 | 类型 | 是否敏感 | 说明 |
|--------|------|----------|------|
| `token` | text | 🔴 是 | 会话令牌 |
| `ipAddress` | text | 🟡 是 | IP地址 |
| `userAgent` | text | 🟡 是 | 用户代理 |

#### 账户表 (accounts)
| 字段名 | 类型 | 是否敏感 | 说明 |
|--------|------|----------|------|
| `accountId` | text | 🟡 是 | 第三方账户ID |
| `providerId` | text | 🟡 是 | 第三方提供商ID |
| `accessToken` | text | 🔴 是 | OAuth访问令牌 |
| `refreshToken` | text | 🔴 是 | OAuth刷新令牌 |
| `idToken` | text | 🔴 是 | OAuth ID令牌 |
| `password` | text | 🔴 是 | OAuth密码 |

#### 验证表 (verifications)
| 字段名 | 类型 | 是否敏感 | 说明 |
|--------|------|----------|------|
| `identifier` | text | 🟡 是 | 验证标识（邮箱/手机号） |
| `value` | text | 🟡 是 | 验证码/令牌 |

---

## 🎯 统一响应格式规范

### 成功响应格式

#### 标准格式
```json
{
  "success": true,
  "data": { ... },
  "message": "操作成功"
}
```

#### 分页数据格式
```json
{
  "success": true,
  "data": {
    "items": [ ... ],
    "pagination": {
      "page": 1,
      "pageSize": 10,
      "total": 100,
      "totalPages": 10
    }
  },
  "message": "查询成功"
}
```

### 错误响应格式（已实现）

```json
{
  "success": false,
  "error": {
    "message": "错误描述",
    "code": "ERROR_CODE",
    "stack": "堆栈信息（仅开发环境）",
    "validationErrors": [...]  // Zod 验证错误
  }
}
```

---

## 📝 敏感字段过滤规则

### 过滤策略

#### 🔴 高敏感字段（完全不返回）
- 密码相关：`userPassword`, `password`
- 令牌相关：`token`, `accessToken`, `refreshToken`, `idToken`
- OAuth凭证：`accountId`, `providerId`

#### 🟡 中敏感字段（按需返回）
- 第三方ID：`unionId`, `mpOpenId`
- IP地址：`lastLoginIp`, `ipAddress`
- 用户代理：`userAgent`
- 系统字段：`isDelete`, `createTime`, `updateTime`

#### 🟢 公开字段（正常返回）
- 基本信息：`id`, `userName`, `userAvatar`, `userProfile`
- 联系方式：`email`, `phone`（需要权限控制）
- 状态信息：`userRole`, `status`, `emailVerified`

### 字段重命名规范

| 原字段名 | 新字段名 | 说明 |
|----------|----------|------|
| `userAccount` | `account` | 用户账号 |
| `userName` | `name` | 用户名 |
| `userAvatar` | `avatar` | 头像 |
| `userProfile` | `profile` | 个人简介 |
| `userRole` | `role` | 用户角色 |
| `createTime` | `createdAt` | 创建时间 |
| `updateTime` | `updatedAt` | 更新时间 |
| `thumbNum` | `thumbCount` | 点赞数 |
| `favourNum` | `favourCount` | 收藏数 |

---

## 🔄 需要修改的接口列表

### 1. 认证接口 (auth)

| 接口 | 路径 | 优先级 | 修改内容 |
|------|------|--------|----------|
| 用户注册 | `POST /api/auth/sign-up/email` | 高 | 统一响应格式，过滤敏感字段 |
| 用户登录 | `POST /api/auth/sign-in/email` | 高 | 统一响应格式，过滤敏感字段 |
| 用户登出 | `POST /api/auth/sign-out` | 中 | 统一响应格式 |
| 获取会话 | `GET /api/auth/get-session` | 中 | 统一响应格式，过滤 `token` |
| 用户注册 | `POST /trpc/auth.signUp` | 高 | 统一响应格式，过滤敏感字段 |
| 用户登录 | `POST /trpc/auth.signIn` | 高 | 统一响应格式，过滤敏感字段 |
| 用户登出 | `POST /trpc/auth.signOut` | 中 | 统一响应格式 |
| 获取会话 | `GET /trpc/auth.getSession` | 中 | 统一响应格式，过滤 `token` |
| 获取用户资料 | `GET /trpc/auth.me` | 高 | 统一响应格式，过滤敏感字段 |

### 2. 用户管理接口 (users)

| 接口 | 路径 | 优先级 | 修改内容 |
|------|------|--------|----------|
| 获取用户列表 | `GET /trpc/users.list` | 高 | 统一响应格式，过滤敏感字段 |
| 根据 ID 获取用户 | `GET /trpc/users.byId` | 高 | 统一响应格式，过滤敏感字段 |
| 创建用户 | `POST /trpc/users.create` | 中 | 统一响应格式，不返回密码 |
| 更新用户 | `POST /trpc/users.update` | 中 | 统一响应格式 |
| 删除用户 | `POST /trpc/users.delete` | 低 | 统一响应格式 |

### 3. 帖子接口 (posts)

| 接口 | 路径 | 优先级 | 修改内容 |
|------|------|--------|----------|
| 创建帖子 | `POST /trpc/posts.create` | 中 | 统一响应格式 |
| 获取帖子列表 | `GET /trpc/posts.list` | 中 | 统一响应格式，分页格式 |
| 删除帖子 | `POST /trpc/posts.delete` | 低 | 统一响应格式 |

### 4. 帖子点赞接口 (postThumbs)

| 接口 | 路径 | 优先级 | 修改内容 |
|------|------|--------|----------|
| 点赞帖子 | `POST /trpc/postThumbs.create` | 低 | 统一响应格式 |
| 取消点赞 | `POST /trpc/postThumbs.delete` | 低 | 统一响应格式 |
| 检查是否已点赞 | `GET /trpc/postThumbs.check` | 低 | 统一响应格式 |
| 获取点赞列表 | `GET /trpc/postThumbs.getByPostId` | 低 | 统一响应格式 |
| 获取用户点赞列表 | `GET /trpc/postThumbs.getByUserId` | 低 | 统一响应格式 |

### 5. 帖子收藏接口 (postFavours)

| 接口 | 路径 | 优先级 | 修改内容 |
|------|------|--------|----------|
| 收藏帖子 | `POST /trpc/postFavours.create` | 低 | 统一响应格式 |
| 取消收藏 | `POST /trpc/postFavours.delete` | 低 | 统一响应格式 |
| 检查是否已收藏 | `GET /trpc/postFavours.check` | 低 | 统一响应格式 |
| 获取收藏列表 | `GET /trpc/postFavours.getByPostId` | 低 | 统一响应格式 |
| 获取用户收藏列表 | `GET /trpc/postFavours.getByUserId` | 低 | 统一响应格式 |

### 6. 题库接口 (questionBanks)

| 接口 | 路径 | 优先级 | 修改内容 |
|------|------|--------|----------|
| 创建题库 | `POST /trpc/questionBanks.create` | 低 | 统一响应格式 |
| 获取题库列表 | `GET /trpc/questionBanks.list` | 低 | 统一响应格式，分页格式 |
| 删除题库 | `POST /trpc/questionBanks.delete` | 低 | 统一响应格式 |

### 7. 题目接口 (questions)

| 接口 | 路径 | 优先级 | 修改内容 |
|------|------|--------|----------|
| 创建题目 | `POST /trpc/questions.create` | 低 | 统一响应格式 |
| 获取题目列表 | `GET /trpc/questions.list` | 低 | 统一响应格式，分页格式 |

---

## 🛠️ 实施计划

### 阶段一：基础设施搭建（1-2天）

#### 1.1 创建响应包装工具
- **文件**: `lib/response-wrapper.ts`
- **功能**:
  - `success(data, message)` - 包装成功响应
  - `paginate(items, pagination, message)` - 包装分页响应
  - `error(error, code)` - 包装错误响应（已存在）
- **示例**:
```typescript
export function success<T>(data: T, message?: string) {
  return {
    success: true,
    data,
    message: message || '操作成功'
  };
}

export function paginate<T>(items: T[], pagination: PaginationMeta, message?: string) {
  return {
    success: true,
    data: {
      items,
      pagination
    },
    message: message || '查询成功'
  };
}
```

#### 1.2 创建数据脱敏工具
- **文件**: `lib/data-sanitizer.ts`
- **功能**:
  - `sanitizeUser(user)` - 过滤用户敏感字段
  - `sanitizeSession(session)` - 过滤会话敏感字段
  - `sanitizeAccount(account)` - 过滤账户敏感字段
- **示例**:
```typescript
export function sanitizeUser(user: any) {
  const { userPassword, unionId, mpOpenId, lastLoginIp, isDelete, ...rest } = user;
  return rest;
}
```

#### 1.3 创建字段转换工具
- **文件**: `lib/field-transformer.ts`
- **功能**:
  - `transformUser(user)` - 转换用户字段命名
  - `transformPost(post)` - 转换帖子字段命名
- **示例**:
```typescript
export function transformUser(user: any) {
  return {
    ...user,
    account: user.userAccount,
    name: user.userName,
    avatar: user.userAvatar,
    profile: user.userProfile,
    role: user.userRole,
    createdAt: user.createTime,
    updatedAt: user.updateTime,
    userAccount: undefined,
    userName: undefined,
    userAvatar: undefined,
    userProfile: undefined,
    userRole: undefined,
    createTime: undefined,
    updateTime: undefined
  };
}
```

### 阶段二：Better-Auth Handler 接口改造（1-2天）

#### 2.1 认证接口改造
- **文件**: `server.ts`
- **修改内容**:
  - 使用响应包装工具
  - 应用数据脱敏
  - 统一错误处理
- **优先级**: 高

#### 2.2 测试验证
- 创建集成测试
- 验证响应格式
- 验证敏感字段过滤

### 阶段三：tRPC 接口改造（2-3天）

#### 3.1 创建 tRPC 中间件
- **文件**: `trpc/middleware/response-wrapper.ts`
- **功能**:
  - 自动包装 tRPC 响应
  - 自动过滤敏感字段
  - 自动转换字段命名
- **示例**:
```typescript
export const responseWrapperMiddleware = t.middleware(async ({ next }) => {
  const result = await next();
  
  // 包装响应
  const wrapped = {
    success: true,
    data: result,
    message: '操作成功'
  };
  
  return wrapped;
});
```

#### 3.3 路由按优先级改造
- **第一批（高优先级）**:
  - `auth.ts` - 认证相关
  - `user.ts` - 用户管理
- **第二批（中优先级）**:
  - `post.ts` - 帖子管理
- **第三批（低优先级）**:
  - `postThumb.ts`, `postFavour.ts`, `questionBank.ts`, `question.ts`

### 阶段四：测试和文档更新（1天）

#### 4.1 单元测试
- 测试响应包装工具
- 测试数据脱敏工具
- 测试字段转换工具

#### 4.2 集成测试
- 测试所有改造后的接口
- 验证响应格式一致性
- 验证敏感字段过滤

#### 4.3 文档更新
- 更新 API 文档
- 添加响应格式说明
- 添加字段说明
- 更新示例代码

---

## 📊 预期成果

### 1. 响应格式统一
- ✅ 所有接口返回统一格式
- ✅ 成功响应包含 `success`, `data`, `message`
- ✅ 错误响应包含 `success`, `error`
- ✅ 分页数据包含 `items`, `pagination`

### 2. 敏感字段过滤
- ✅ 密码字段永不返回
- ✅ 令牌字段按需返回
- ✅ 系统字段按角色返回

### 3. 字段规范化
- ✅ 统一字段命名（camelCase）
- ✅ 统一时间格式（ISO 8601）
- ✅ 统一布尔值格式

### 4. 代码质量
- ✅ 类型安全
- ✅ 易于维护
- ✅ 可扩展性强

---

## ⚠️ 注意事项

### 1. 向后兼容性
- tRPC 响应格式改变会影响前端
- 需要前端团队配合调整
- 建议分阶段发布，避免一次性大改

### 2. 性能影响
- 数据脱敏和字段转换会增加 CPU 开销
- 建议在开发环境测试性能
- 考虑使用缓存优化

### 3. 安全性
- 确保敏感字段不会通过其他途径泄露
- 定期审计敏感字段列表
- 测试各种边界情况

### 4. 测试覆盖
- 确保所有接口都有测试覆盖
- 测试正常情况和错误情况
- 测试权限控制

---

## 📅 时间估算

| 阶段 | 任务 | 预计时间 |
|------|------|----------|
| 阶段一 | 基础设施搭建 | 1-2天 |
| 阶段二 | Better-Auth Handler 改造 | 1-2天 |
| 阶段三 | tRPC 接口改造 | 2-3天 |
| 阶段四 | 测试和文档更新 | 1天 |
| **总计** | - | **5-8天** |

---

## 🎯 下一步行动

1. **审查本计划** - 确认需求和优先级
2. **搭建基础设施** - 创建工具函数
3. **开始改造** - 按优先级逐个改造接口
4. **持续测试** - 每改造一个接口就测试
5. **更新文档** - 及时更新 API 文档

---

**文档创建日期**: 2026-01-30  
**文档版本**: 1.0  
**负责人**: 后端团队