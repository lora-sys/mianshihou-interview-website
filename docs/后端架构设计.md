# 后端架构设计

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              客户端 (Browser/Mobile)                         │
└────────────────────────────┬────────────────────────────────────────────────┘
                             │
                             │ HTTP/HTTPS
                             │
┌────────────────────────────▼────────────────────────────────────────────────┐
│                          Fastify Server (端口 3001)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                           中间件层                                      │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │  │
│  │  │  CORS 处理   │  │  Cookie 处理 │  │  日志记录    │              │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                           路由层                                        │  │
│  │                                                                        │  │
│  │  ┌──────────────────────────────────────────────────────────────┐    │  │
│  │  │  /api/auth/*  → Better-Auth 认证路由                        │    │  │
│  │  │    - signUp        : 注册                                    │    │  │
│  │  │    - signIn        : 登录                                    │    │  │
│  │  │    - signOut       : 登出                                    │    │  │
│  │  └──────────────────────────────────────────────────────────────┘    │  │
│  │                                                                        │  │
│  │  ┌──────────────────────────────────────────────────────────────┐    │  │
│  │  │  /trpc/*  → tRPC API 路由                                   │    │  │
│  │  │    ├─ auth:          认证相关                                │    │  │
│  │  │    │    ├─ signUp   : 注册                                   │    │  │
│  │  │    │    ├─ signIn   : 登录（并发检测）                        │    │  │
│  │  │    │    ├─ signOut  : 登出                                   │    │  │
│  │  │    │    ├─ myDevices: 活跃设备列表                           │    │  │
│  │  │    │    ├─ revokeDevice: 踢出设备                            │    │  │
│  │  │    │    └─ revokeAllDevices: 踢出所有设备                    │    │  │
│  │  │    │                                                      │    │  │
│  │  │    ├─ users:         用户管理                                 │    │  │
│  │  │    │    ├─ list         : 用户列表                                │    │  │
│  │  │    │    ├─ byId         : 用户详情                                │    │  │
│  │  │    │    ├─ create       : 创建用户                                │    │  │
│  │  │    │    ├─ update       : 更新用户                                │    │  │
│  │  │    │    ├─ delete       : 删除用户                                │    │  │
│  │  │    │    ├─ batchCreate  : 批量创建用户                            │    │  │
│  │  │    │    ├─ batchDelete  : 批量删除用户                            │    │  │
│  │  │    │    └─ listWithStats: 用户列表 + 统计信息                      │    │  │
│  │  │    │                                                      │    │  │
│  │  │    ├─ questions:     题目管理                                 │    │  │
│  │  │    │    ├─ list         : 题目列表                                │    │  │
│  │  │    │    ├─ byId         : 题目详情                                │    │  │
│  │  │    │    ├─ create       : 创建题目                                │    │  │
│  │  │    │    ├─ update       : 更新题目                                │    │  │
│  │  │    │    ├─ delete       : 删除题目                                │    │  │
│  │  │    │    ├─ batchCreate  : 批量创建题目                            │    │  │
│  │  │    │    └─ batchDelete  : 批量删除题目                            │    │  │
│  │  │    │                                                      │    │  │
│  │  │    ├─ questionBanks: 题库管理                                 │    │  │
│  │  │    │    ├─ list                : 题库列表                        │    │  │
│  │  │    │    ├─ byId                : 题库详情                        │    │  │
│  │  │    │    ├─ create              : 创建题库                        │    │  │
│  │  │    │    ├─ update              : 更新题库                        │    │  │
│  │  │    │    ├─ delete              : 删除题库                        │    │  │
│  │  │    │    ├─ batchCreate         : 批量创建题库                    │    │  │
│  │  │    │    ├─ batchDelete         : 批量删除题库                    │    │  │
│  │  │    │    └─ listWithQuestionCount: 题库列表 + 题目数量           │    │  │
│  │  │    │                                                      │    │  │
│  │  │    ├─ upload:       文件上传                                   │    │  │
│  │  │    │    ├─ uploadAvatar    : 上传头像                            │    │  │
│  │  │    │    ├─ uploadAttachment: 上传附件                            │    │  │
│  │  │    │    ├─ deleteFile      : 删除文件                            │    │  │
│  │  │    │    ├─ getFileInfo     : 获取文件信息                         │    │  │
│  │  │    │    └─ batchDeleteFiles: 批量删除文件                       │    │  │
│  │  │    │                                                      │    │  │
│  │  │    ├─ posts:         帖子管理                                 │    │  │
│  │  │    │    ├─ list              : 帖子列表                        │    │  │
│  │  │    │    ├─ byId              : 帖子详情                        │    │  │
│  │  │    │    ├─ create            : 创建帖子                        │    │  │
│  │  │    │    ├─ update            : 更新帖子                        │    │  │
│  │  │    │    ├─ delete            : 删除帖子                        │    │  │
│  │  │    │    └─ listWithUserStatus: 帖子列表 + 用户状态            │    │  │
│  │  │    │                                                      │    │  │
│  │  │    ├─ postThumbs:    点赞管理                                 │    │  │
│  │  │    │    ├─ toggle   : 切换点赞                                │    │  │
│  │  │    │    └─ check    : 检查点赞状态                            │    │  │
│  │  │    │                                                      │    │  │
│  │  │    ├─ postFavours:   收藏管理                                 │    │  │
│  │  │    │    ├─ toggle   : 切换收藏                                │    │  │
│  │  │    │    └─ check    : 检查收藏状态                            │    │  │
│  │  │    │                                                      │    │  │
│  │  │    ├─ health:        健康检查                                 │    │  │
│  │  │    └─ hello:         测试接口                                 │    │  │
│  │  └──────────────────────────────────────────────────────────────┘    │  │
│  │                                                                        │  │
│  │  ┌──────────────────────────────────────────────────────────────┐    │  │
│  │  │  /health/*  → 健康检查路由                                   │    │  │
│  │  │    - /health         : 详细健康检查                            │    │  │
│  │  │    - /health/live    : 存活检查 (Kubernetes)                  │    │  │
│  │  │    - /health/ready   : 就绪检查 (Kubernetes)                  │    │  │
│  │  └──────────────────────────────────────────────────────────────┘    │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         tRPC 中间件层                                  │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │  │
│  │  │  权限验证    │  │  上下文创建   │  │  错误处理    │              │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │  │
│  │  │  输入验证    │  │  API 签名验证 │  │  限流控制    │              │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────────────────┐
│                          工具库层 (lib/)                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                          认证与设备管理                               │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐      │  │
│  │  │   auth.ts       │  │ device-finger-  │  │ concurrent-     │      │  │
│  │  │ Better-Auth     │  │ print.ts        │  │ login.ts        │      │  │
│  │  │ 初始化          │  │ 设备指纹识别     │  │ 并发登录控制     │      │  │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘      │  │
│  │  ┌─────────────────┐                                                   │  │
│  │  │ cookie-utils.ts │                                                   │  │
│  │  │ Cookie 工具函数 │                                                   │  │
│  │  └─────────────────┘                                                   │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                          数据处理与验证                                 │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐      │  │
│  │  │ data-sanitizer  │  │ field-trans-    │  │ errors.ts       │      │  │
│  │  │ .ts             │  │ former.ts       │  │ 错误类型定义    │      │  │
│  │  │ 数据脱敏        │  │ 字段转换        │  │                 │      │  │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘      │  │
│  │  ┌─────────────────┐  ┌─────────────────┐                            │  │
│  │  │ exception.ts    │  │ response-wr-    │                            │  │
│  │  │ 异常处理工具    │  │ apper.ts        │                            │  │
│  │  │                 │  │ 统一响应格式    │                            │  │
│  │  └─────────────────┘  └─────────────────┘                            │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                          缓存与存储                                    │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐      │  │
│  │  │   cache.ts      │  │ cache-protec-   │  │   redis.ts      │      │  │
│  │  │ 缓存客户端      │  │ tion.ts         │  │ Redis 客户端    │      │  │
│  │  │                 │  │ 缓存防护        │  │ 单例管理        │      │  │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘      │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                          安全防护                                       │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐      │  │
│  │  │ rate-limiter.ts │  │ input-validator │  │ xss-protection  │      │  │
│  │  │ 请求限流        │  │ .ts             │  │ .ts             │      │  │
│  │  │ 滑动窗口算法    │  │ SQL 注入防护    │  │ XSS 防护        │      │  │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘      │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐      │  │
│  │  │ ip-list.ts      │  │ api-signature.ts│  │ file-storage.ts  │      │  │
│  │  │ IP 黑白名单     │  │ API 签名验证    │  │ 文件存储        │      │  │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘      │  │
│  │  ┌─────────────────┐                                                   │  │
│  │  │ image-processor │                                                   │  │
│  │  │ .ts             │                                                   │  │
│  │  │ 图片处理        │                                                   │  │
│  │  └─────────────────┘                                                   │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                          系统监控                                      │  │
│  │  ┌─────────────────┐  ┌─────────────────┐                            │  │
│  │  │   logger.ts     │  │    health.ts    │                            │  │
│  │  │ 日志记录        │  │ 健康检查        │                            │  │
│  │  │ (Loki 集成)     │  │                 │                            │  │
│  │  └─────────────────┘  └─────────────────┘                            │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                          数据库事务                                    │  │
│  │  ┌─────────────────┐                                                   │  │
│  │  │  transaction.ts │                                                   │  │
│  │  │ 事务管理工具    │                                                   │  │
│  │  └─────────────────┘                                                   │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────────────────┐
│                          定时任务层 (tasks/)                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  cleanup-schedule.ts  → 定时任务调度器                                │  │
│  │    - schedule: 使用 node-cron 调度                                   │  │
│  │    - startCleanupTasks(): 启动所有清理任务                           │  │
│  │    - stopCleanupTasks(): 停止所有清理任务                            │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  cleanup/sessions.ts      → 清理过期会话                              │  │
│  │    - 频率: 每天凌晨 2 点                                              │  │
│  │    - 功能: 删除过期的 Better-Auth 会话                                │  │
│  │    - 关联: 同步清理 Redis 中的设备信息                               │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  cleanup/verification.ts  → 清理过期验证码                            │  │
│  │    - 频率: 每小时                                                      │  │
│  │    - 功能: 删除过期的邮箱验证码                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  cleanup/tokens.ts        → 清理过期 Token                            │  │
│  │    - 频率: 每天凌晨 3 点                                              │  │
│  │    - 功能: 清理过期的 OAuth Token 账户（保留至少一个）                │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  cleanup/soft-delete.ts    → 清理软删除数据                           │  │
│  │    - 频率: 每天凌晨 4 点                                              │  │
│  │    - 功能: 清理超过 90 天的软删除数据（帖子、题目、题库）             │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└────────────────────────────┬────────────────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────────────────┐
│                          数据持久化层                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                          PostgreSQL 数据库                              │  │
│  │  ┌───────────────────────────────────────────────────────────────┐    │  │
│  │  │ 核心表                                                        │    │  │
│  │  │  ├─ user              : 用户表                                │    │  │
│  │  │  ├─ session           : 会话表 (Better-Auth)                   │    │  │
│  │  │  ├─ account           : 账户表 (OAuth)                         │    │  │
│  │  │  ├─ verification      : 验证表 (邮箱验证)                      │    │  │
│  │  │                                                               │    │  │
│  │  │ 题库相关                                                      │    │  │
│  │  │  ├─ question          : 题目表                                │    │  │
│  │  │  ├─ question_bank     : 题库表                                │    │  │
│  │  │  └─ question_bank_question : 题库题目关联表                   │    │  │
│  │  │                                                               │    │  │
│  │  │ 社区相关                                                      │    │  │
│  │  │  ├─ post              : 帖子表                                │    │  │
│  │  │  ├─ post_thumb        : 点赞表                                │    │  │
│  │  │  └─ post_favour       : 收藏表                                │    │  │
│  │  └───────────────────────────────────────────────────────────────┘    │  │
│  │                                                                   │    │  │
│  │  ORM: Drizzle ORM                                                │    │  │
│  │  - Schema 定义: db/schema.ts                                      │    │  │
│  │  - 类型安全的查询                                                  │    │  │
│  │  - 事务支持                                                        │    │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                          Redis 缓存                                    │  │
│  │  ┌───────────────────────────────────────────────────────────────┐    │  │
│  │  │ 缓存类型                                                        │    │  │
│  │  │  ├─ 普通缓存 (get/set)                                          │    │  │
│  │  │  ├─ Tag 缓存 (按标签清理)                                       │    │  │
│  │  │  ├─ Version 缓存 (版本控制)                                     │    │  │
│  │  │  └─ Null 缓存 (防止缓存穿透)                                   │    │  │
│  │  │                                                               │    │  │
│  │  │ 缓存防护                                                        │    │  │
│  │  │  ├─ 缓存穿透 (Null Caching)                                     │    │  │
│  │  │  ├─ 缓存击穿 (Double Check Lock)                               │    │  │
│  │  │  └─ 缓存雪崩 (Random TTL)                                       │    │  │
│  │  │                                                               │    │  │
│  │  │ 设备管理 (设备识别和并发登录)                                   │    │  │
│  │  │  ├─ devices:{userId}         → 用户活跃设备列表               │    │  │
│  │  │  ├─ device:{userId}:{fp}      → 设备详细信息                   │    │  │
│  │  │  ├─ device_sessions:{userId}:{fp} → 设备会话集合               │    │  │
│  │  │  └─ login_lock:{userId}       → 并发登录分布式锁               │    │  │
│  │  └───────────────────────────────────────────────────────────────┘    │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 技术栈

### 核心框架
- **Fastify**: 高性能 Web 框架
- **tRPC**: 类型安全的 API 层
- **Better-Auth**: 现代化认证框架

### 数据库与缓存
- **PostgreSQL**: 主数据库 (Drizzle ORM)
- **Redis**: 缓存和会话存储

### 安全防护
- **DOMPurify**: XSS 防护
- **sanitize-html**: HTML 清理
- **crypto**: API 签名验证
- **Sharp**: 图片处理

### 开发工具
- **TypeScript**: 类型安全
- **Bun**: JavaScript 运行时和包管理器
- **Zod**: 数据验证
- **ESLint**: 代码检查
- **Prettier**: 代码格式化

### 运维工具
- **Docker**: 容器化
- **Docker Compose**: 本地开发环境
- **GitHub Actions**: CI/CD
- **Loki**: 日志聚合

## 关键设计特性

### 1. 类型安全
- tRPC 实现前后端类型共享
- Drizzle ORM 提供数据库类型安全
- Zod 进行运行时数据验证

### 2. 认证与安全
- Better-Auth 处理认证流程
- 设备指纹识别防止并发登录
- 数据脱敏保护敏感信息
- CORS 跨域控制
- **请求限流**: Redis 滑动窗口算法防止滥用
- **SQL 注入防护**: 输入验证和关键词检测
- **XSS 防护**: HTML 实体编码和 DOMPurify 清理
- **IP 访问控制**: 黑白名单管理
- **API 签名验证**: HMAC-SHA256 防止篡改和重放攻击

### 3. 缓存策略
- Redis 多级缓存 (普通/Tag/Version/Null)
- 缓存防护 (穿透/击穿/雪崩)
- 自动过期清理

### 4. 性能优化
- 事务管理
- 数据库索引优化
- 连接池管理
- 异步处理

### 5. 监控与运维
- 结构化日志
- 健康检查端点
- 优雅关闭
- 定时清理任务

### 6. 错误处理
- 统一错误响应格式
- 开发环境堆栈信息
- Zod 验证错误处理
- 自定义错误类型

## API 路由结构

```
/
├── /api/auth/*          # Better-Auth 认证路由
├── /trpc/*              # tRPC API 路由
│   ├── auth
│   ├── users
│   ├── questions
│   ├── questionBanks
│   ├── upload           # 文件上传路由
│   ├── posts
│   ├── postThumbs
│   ├── postFavours
│   ├── health
│   └── hello
└── /health/*            # 健康检查路由
    ├── /health
    ├── /health/live
    └── /health/ready
```

## 数据流

### 登录流程
```
客户端 → Fastify → tRPC Router → Better-Auth → 数据库
                ↓
         并发登录检测
                ↓
         Redis 设备管理
```

### 数据查询流程
```
客户端 → tRPC Router → 缓存层 → Redis (缓存命中)
                              ↓
                         数据库 (缓存未命中)
                              ↓
                         更新缓存
```

### 清理任务流程
```
定时调度器 → 清理任务 → 数据库查询 → 删除过期数据
                                ↓
                           Redis 清理
```

## 安全防护体系

### 1. 请求限流
- **实现方式**: Redis 滑动窗口算法
- **功能**: 防止 API 滥用和 DDoS 攻击
- **配置**: 支持按用户、IP、端点配置不同限流策略
- **文件**: `lib/rate-limiter.ts`, `middlewares/rate-limit.ts`

### 2. SQL 注入防护
- **实现方式**: 输入验证和关键词检测
- **功能**: 检测并阻止恶意 SQL 语句
- **特性**:
  - SQL 关键词检测 (SELECT, INSERT, DELETE, DROP 等)
  - 危险字符过滤 (;, --, /*, */)
  - 特殊字符检查 (', ", =)
- **文件**: `lib/input-validator.ts`, `trpc/middleware/input-validation.ts`

### 3. XSS 防护
- **实现方式**: HTML 实体编码和 DOMPurify 清理
- **功能**: 防止跨站脚本攻击
- **特性**:
  - HTML 实体编码 (<, >, ", &, ')
  - HTML 属性值编码
  - JavaScript 字符串编码
  - DOMPurify HTML 清理
- **文件**: `lib/xss-protection.ts`

### 4. IP 访问控制
- **实现方式**: Redis 存储黑白名单
- **功能**: 控制特定 IP 的访问权限
- **特性**:
  - 支持单个 IP 和 CIDR 范围
  - 白名单优先级高于黑名单
  - 管理端点: 添加/删除/查看 IP
- **文件**: `lib/ip-list.ts`, `middlewares/ip-control.ts`

### 5. API 签名验证
- **实现方式**: HMAC-SHA256 签名
- **功能**: 防止请求篡改和重放攻击
- **特性**:
  - 时间戳验证 (防止重放)
  - Nonce 唯一性验证
  - 密钥管理
- **文件**: `lib/api-signature.ts`, `trpc/middleware/signature.ts`

### 6. 文件上传安全
- **实现方式**: 文件类型和大小验证
- **功能**: 安全的文件上传处理
- **特性**:
  - MIME 类型白名单验证
  - 文件扩展名验证
  - 文件大小限制
  - 图片自动压缩处理
  - 唯一文件名生成
- **文件**: `lib/file-storage.ts`, `lib/image-processor.ts`, `trpc/router/upload.ts`

### 7. 日志聚合
- **实现方式**: Loki 集成
- **功能**: 集中式日志管理
- **特性**:
  - 结构化日志记录
  - 追踪信息 (traceId, userId, requestId)
  - 多种日志级别
  - 生产环境自动上传到 Loki
- **文件**: `lib/logger.ts`

## 批量操作

### 支持的批量操作
- **用户管理**: 批量创建/删除用户
- **题目管理**: 批量创建/删除题目
- **题库管理**: 批量创建/删除题库
- **文件管理**: 批量删除文件

### 批量操作特性
- 事务安全
- 错误隔离
- 详细的结果报告
- 最大数量限制 (100 条)

## 文件上传

### 支持的文件类型
- **图片**: JPEG, PNG, GIF, WebP, SVG
- **文档**: PDF, Word, Excel, Text, Markdown

### 文件大小限制
- **头像**: 5MB
- **附件**: 10MB

### 图片处理
- **头像**: 200x200, JPEG 格式, 85% 质量
- **附件**: 1920x1080, JPEG 格式, 80% 质量