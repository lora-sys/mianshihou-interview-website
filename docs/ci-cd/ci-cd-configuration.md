# CI/CD 配置说明

## 📖 为什么集成测试不在 CI/CD 中运行？

### 核心理念

**集成测试应该在本地运行，在推送代码前完成。**

### 原因分析

#### 1. CI/CD 的主要目的

CI/CD（持续集成/持续部署）的主要目标是：
- ✅ **快速反馈**：几分钟内给出结果
- ✅ **代码质量检查**：验证代码逻辑
- ✅ **防止明显错误**：避免有 bug 的代码进入主分支

#### 2. 集成测试的特点

集成测试需要：
- ❌ **数据库连接**：需要 PostgreSQL
- ❌ **外部依赖**：需要网络、API 等
- ❌ **运行时间长**：2-3 分钟
- ❌ **配置复杂**：需要多个环境变量
- ❌ **资源消耗大**：需要更多 CPU 和内存

#### 3. 为什么不适合 CI/CD？

| 方面 | 单元测试 | 集成测试 |
|------|---------|---------|
| 运行时间 | ~1 分钟 | ~3 分钟 |
| 资源消耗 | 低 | 高 |
| 配置复杂度 | 简单 | 复杂 |
| 故障率 | 低 | 高 |
| 反馈速度 | 快 | 慢 |

**结论**：集成测试会拖慢 CI/CD 速度，增加配置复杂度，不适合在 CI/CD 中运行。

## 🎯 最佳实践

### 开发流程

```
1. 编写代码
   ↓
2. 编写/更新测试
   ↓
3. 本地运行单元测试 ✅
   ↓
4. 本地运行集成测试 ✅
   ↓
5. 修复问题
   ↓
6. 所有测试通过 ✅
   ↓
7. 推送代码
   ↓
8. CI/CD 自动运行单元测试 ✅
   ↓
9. 代码合并到主分支
```

### 测试分工

| 测试类型 | 运行位置 | 时机 | 负责人 |
|---------|---------|------|--------|
| **单元测试** | CI/CD | 每次推送 | 自动化 |
| **集成测试** | 本地 | 推送前 | 开发者 |
| **端到端测试** | 测试环境 | 发布前 | QA 团队 |

## 🔧 当前 CI/CD 配置

### GitHub Actions 工作流

**文件**: `.github/workflows/test.yml`

**包含任务**:
1. ✅ **Unit Tests** - 运行单元测试
2. ✅ **Code Quality** - TypeScript 检查

**不包含**:
- ❌ 集成测试（需要数据库）
- ❌ 数据库迁移
- ❌ 数据库初始化

### 触发条件

- 推送到 `main` 分支
- 创建针对 `main` 分支的 Pull Request

## 📊 测试覆盖率

### 单元测试覆盖率

- **目标**: > 80%
- **当前**: ~60%
- **文件**:
  - `lib/errors.ts` - 100%
  - `lib/exception.ts` - 98.51%
  - `lib/logger.ts` - 100%
  - `lib/cookie-utils.ts` - 46.43%

### 集成测试覆盖率

- **目标**: > 70%
- **当前**: ~50%
- **文件**:
  - `lib/auth.ts` - 100%
  - `trpc/index.ts` - 100%
  - `trpc/router/auth.ts` - 43.70%

## 🚀 如何使用

### 本地开发

1. **运行单元测试**:
   ```bash
   cd mianshihou/apps/api
   bun test tests/unit
   ```

2. **运行集成测试**:
   ```bash
   cd mianshihou/apps/api
   bun test tests/integration
   ```

3. **运行所有测试**:
   ```bash
   cd mianshihou/apps/api
   bun test
   ```

### 推送代码前

确保：
- ✅ 单元测试通过
- ✅ 集成测试通过
- ✅ TypeScript 编译通过

```bash
cd mianshihou/apps/api
bun test tests/unit
bun test tests/integration
bun run build
```

### 推送代码后

- ✅ CI/CD 自动运行单元测试
- ✅ CI/CD 自动运行 TypeScript 检查
- ✅ 如果失败，修复后重新推送

## 💡 优势

### 1. 更快的 CI/CD

- **之前**: 运行所有测试（~4 分钟）
- **现在**: 只运行单元测试（~1 分钟）
- **提升**: 4 倍速度提升

### 2. 更稳定的 CI/CD

- **之前**: 依赖数据库，容易失败
- **现在**: 无外部依赖，更稳定

### 3. 更好的开发体验

- 本地快速反馈
- 推送前发现问题
- 减少 CI/CD 失败

### 4. 更低的成本

- 减少服务器资源使用
- 减少 GitHub Actions 分钟数消耗

## 🎓 经验教训

### 1. 不要在 CI/CD 中做复杂的事情

CI/CD 应该：
- ✅ 快速
- ✅ 简单
- ✅ 可靠

CI/CD 不应该：
- ❌ 慢
- ❌ 复杂
- ❌ 不稳定

### 2. 本地测试很重要

- 推送前一定要在本地运行测试
- 不要依赖 CI/CD 发现问题
- 早期发现，早期修复

### 3. 测试金字塔

```
        /\
       /E2E\      - 少量
      /------\
     /集成测试\    - 适量
    /----------\
   /  单元测试  \   - 大量
  /--------------\
```

- 单元测试：最多（70-80%）
- 集成测试：适量（15-20%）
- 端到端测试：最少（5-10%）

## 📚 参考资料

- [测试金字塔](https://martinfowler.com/bliki/TestPyramid.html)
- [CI/CD 最佳实践](https://www.atlassian.com/continuous-delivery/principles/continuous-integration-vs-delivery-vs-deployment)
- [GitHub Actions 文档](https://docs.github.com/en/actions)

## 🎯 总结

**核心理念**：

> "集成测试应该在本地运行，在推送代码前完成。"

**好处**：
- ✅ CI/CD 更快
- ✅ CI/CD 更稳定
- ✅ 本地快速反馈
- ✅ 推送前发现问题
- ✅ 降低成本

**记住**：
- 🧪 在本地运行所有测试
- 🔍 确保所有测试通过后再推送
- 🚀 CI/CD 会自动运行单元测试
- 📊 定期检查测试覆盖率

这样既能保证代码质量，又能提高开发效率！