# 接口响应格式统一和权限控制实施计划

## 📋 项目目标

1. **统一响应格式** - 所有 tRPC 接口应用统一响应格式
2. **权限控制分离** - 完善权限中间件，支持细粒度权限
3. **接口配置** - 为每个接口配置响应包装和权限
4. **测试驱动开发** - 使用 TDD 方式确保质量
5. **更新文档** - 同步更新 API 接口文档

---

## 🔍 现状分析

### 1. 现有路由结构

| 路由文件 | 接口数量 | 状态 | 优先级 |
|---------|---------|------|--------|
| `auth.ts` | 4 | 需要改造 | 高 |
| `user.ts` | 5 | 需要改造 | 高 |
| `post.ts` | 3 | 需要改造 | 中 |
| `postThumb.ts` | 5 | 需要改造 | 中 |
| `postFavour.ts` | 5 | 需要改造 | 中 |
| `questionBank.ts` | 3 | 需要改造 | 低 |
| `question.ts` | 2 | 需要改造 | 低 |

### 2. 现有中间件

| 中间件 | 状态 | 说明 |
|--------|------|------|
| `cache.ts` | ✅ 已实现 | 缓存中间件 |
| `permissions.ts` | ⚠️ 需要完善 | 权限中间件 |
| `response-wrapper.ts` | ✅ 已创建 | 响应包装中间件（未应用） |

### 3. 现有权限定义

```typescript
// 用户角色
enum UserRole {
  ADMIN = 'admin',      // 管理员
  USER = 'user',        // 普通用户
}

// 资源权限
enum ResourcePermission {
  READ = 'read',        // 读取
  WRITE = 'write',      // 写入
  DELETE = 'delete',    // 删除
  MANAGE = 'manage',    // 管理
}
```

---

## 🎯 统一响应格式规范

### 成功响应

```typescript
{
  success: true,
  data: T,
  message: string
}
```

### 分页响应

```typescript
{
  success: true,
  data: {
    items: T[],
    pagination: {
      page: number,
      pageSize: number,
      total: number,
      totalPages: number
    }
  },
  message: string
}
```

### 错误响应（已实现）

```typescript
{
  success: false,
  error: {
    message: string,
    code: string,
    stack?: string,
    validationErrors?: Array<{ path: string; message: string }>
  }
}
```

---

## 🔐 权限控制策略

### 1. 权限级别

| 级别 | 说明 | 示例 |
|------|------|------|
| `public` | 公开访问 | 健康检查、公开数据 |
| `authenticated` | 需要登录 | 获取个人资料 |
| `owner` | 仅资源所有者 | 更新自己的帖子 |
| `admin` | 仅管理员 | 删除用户、管理题库 |

### 2. 权限检查顺序

```
1. 认证检查 → 是否登录
2. 角色检查 → 是否有对应角色
3. 资源检查 → 是否是资源所有者
4. 权限检查 → 是否有操作权限
```

### 3. 权限规则

| 资源 | 操作 | 权限要求 |
|------|------|----------|
| 用户 | 读取自己 | authenticated + owner |
| 用户 | 更新自己 | authenticated + owner |
| 用户 | 删除 | admin |
| 用户 | 列表 | admin |
| 帖子 | 创建 | authenticated |
| 帖子 | 读取 | public |
| 帖子 | 更新 | authenticated + owner |
| 帖子 | 删除 | authenticated + owner |
| 帖子 | 点赞 | authenticated |
| 题库 | 创建 | authenticated |
| 题库 | 删除 | admin |

---

## 📝 接口改造计划

### 阶段一：认证接口 (auth.ts) - 高优先级

| 接口 | 路径 | 权限 | 响应格式 | 状态 |
|------|------|------|----------|------|
| 注册 | `auth.signUp` | public | success | 待改造 |
| 登录 | `auth.signIn` | public | success | 待改造 |
| 登出 | `auth.signOut` | authenticated | success | 待改造 |
| 获取会话 | `auth.getSession` | authenticated | success | 待改造 |
| 获取用户资料 | `auth.me` | authenticated | success | 待改造 |

**改造内容**：
- 应用响应包装中间件
- 脱敏用户数据
- 转换字段命名
- 添加权限检查

### 阶段二：用户管理接口 (user.ts) - 高优先级

| 接口 | 路径 | 权限 | 响应格式 | 状态 |
|------|------|------|----------|------|
| 获取用户列表 | `users.list` | admin | paginate | 待改造 |
| 根据 ID 获取用户 | `users.byId` | admin | success | 待改造 |
| 创建用户 | `users.create` | admin | success | 待改造 |
| 更新用户 | `users.update` | owner | success | 待改造 |
| 删除用户 | `users.delete` | admin | success | 待改造 |

**改造内容**：
- 应用响应包装中间件
- 脱敏用户数据
- 转换字段命名
- 添加细粒度权限检查

### 阶段三：帖子接口 (post.ts) - 中优先级

| 接口 | 路径 | 权限 | 响应格式 | 状态 |
|------|------|------|----------|------|
| 创建帖子 | `posts.create` | authenticated | success | 待改造 |
| 获取帖子列表 | `posts.list` | public | paginate | 待改造 |
| 删除帖子 | `posts.delete` | owner | success | 待改造 |

**改造内容**：
- 应用响应包装中间件
- 转换字段命名（thumbNum → thumbCount）
- 添加权限检查

### 阶段四：互动接口 - 中优先级

| 路由文件 | 接口数量 | 权限 | 响应格式 | 状态 |
|---------|---------|------|----------|------|
| `postThumb.ts` | 5 | authenticated | success | 待改造 |
| `postFavour.ts` | 5 | authenticated | success | 待改造 |

**改造内容**：
- 应用响应包装中间件
- 添加权限检查

### 阶段五：题库接口 - 低优先级

| 路由文件 | 接口数量 | 权限 | 响应格式 | 状态 |
|---------|---------|------|----------|------|
| `questionBank.ts` | 3 | authenticated/admin | paginate | 待改造 |
| `question.ts` | 2 | authenticated | paginate | 待改造 |

**改造内容**：
- 应用响应包装中间件
- 添加权限检查

---

## 🛠️ TDD 实施步骤

### 步骤 1: 改造认证接口（TDD）

#### 1.1 编写测试

**文件**: `tests/integration/auth-formatted.test.ts`

```typescript
import { describe, it, expect } from 'bun:test';

describe('Auth Formatted Responses', () => {
  it('should return formatted response for sign up', async () => {
    const response = await fastify.inject({
      method: 'POST',
      url: '/trpc/auth.signUp',
      payload: {
        email: 'test@example.com',
        password: 'password123',
        name: 'Test User'
      }
    });

    expect(response.statusCode).toBe(200);
    const body = response.json();
    
    // 验证统一响应格式
    expect(body).toHaveProperty('success', true);
    expect(body).toHaveProperty('data');
    expect(body).toHaveProperty('message');
    
    // 验证用户数据脱敏
    expect(body.data).not.toHaveProperty('userPassword');
    
    // 验证字段转换
    expect(body.data.user).toHaveProperty('name', 'Test User');
    expect(body.data.user).toHaveProperty('account', 'test@example.com');
  });

  it('should return formatted response for get session', async () => {
    // ... 测试代码
  });
});
```

#### 1.2 实现改造

**文件**: `trpc/router/auth.ts`

```typescript
import { router, protectedProcedure } from '../index';
import { success } from '../../lib/response-wrapper';
import { sanitizeUser, transformUser } from '../../lib/data-sanitizer';

export const authRouter = router({
  signUp: publicProcedure
    .input(z.object({
      email: z.string().email(),
      password: z.string().min(6),
      name: z.string().optional()
    }))
    .mutation(async ({ input }) => {
      // 业务逻辑
      const user = await createUser(input);
      
      // 脱敏和转换
      const transformedUser = transformUser(sanitizeUser(user));
      
      // 包装响应
      return success(transformedUser, '注册成功');
    }),

  getSession: protectedProcedure
    .query(async ({ ctx }) => {
      // 业务逻辑
      const session = await getSessionByToken(ctx.token);
      
      // 脱敏和转换
      const transformedUser = transformUser(sanitizeUser(session.user));
      
      // 包装响应
      return success({
        session: {
          ...session,
          // 过滤敏感字段
          token: undefined
        },
        user: transformedUser
      }, '获取会话成功');
    }),
});
```

#### 1.3 运行测试

```bash
bun test tests/integration/auth-formatted.test.ts
```

### 步骤 2: 完善权限中间件

#### 2.1 编写权限测试

**文件**: `tests/unit/permissions.test.ts`

```typescript
import { describe, it, expect } from 'bun:test';
import { checkPermission, isOwner, hasRole } from '../trpc/middleware/permissions';

describe('Permissions', () => {
  it('should check if user is resource owner', () => {
    const user = { id: 'user1', role: 'user' };
    const resource = { userId: 'user1' };
    
    expect(isOwner(user, resource)).toBe(true);
  });

  it('should check if user has admin role', () => {
    const user = { id: 'user1', role: 'admin' };
    
    expect(hasRole(user, 'admin')).toBe(true);
  });

  it('should check if user has required permission', () => {
    const user = { id: 'user1', role: 'user' };
    const resource = { userId: 'user1' };
    const requiredPermission = 'write';
    
    expect(checkPermission(user, resource, requiredPermission)).toBe(true);
  });
});
```

#### 2.2 实现权限中间件

**文件**: `trpc/middleware/permissions.ts`

```typescript
import { TRPCError } from '@trpc/server';
import { initTRPC, TRPCError } from '@trpc/server';

/**
 * 权限类型
 */
export enum Permission {
  READ = 'read',
  WRITE = 'write',
  DELETE = 'delete',
  MANAGE = 'manage',
}

/**
 * 检查用户是否是资源所有者
 */
export function isOwner(user: any, resource: any): boolean {
  if (!user || !resource) return false;
  return user.id === resource.userId || user.id === resource.id;
}

/**
 * 检查用户角色
 */
export function hasRole(user: any, role: string): boolean {
  if (!user) return false;
  return user.role === role;
}

/**
 * 检查用户是否是管理员
 */
export function isAdmin(user: any): boolean {
  return hasRole(user, 'admin');
}

/**
 * 创建需要认证的中间件
 */
export const requireAuth = t.middleware(({ ctx, next }) => {
  if (!ctx.user) {
    throw new TRPCError({
      code: 'UNAUTHORIZED',
      message: '未授权访问',
    });
  }
  return next();
});

/**
 * 创建需要管理员权限的中间件
 */
export const requireAdmin = t.middleware(({ ctx, next }) => {
  if (!ctx.user) {
    throw new TRPCError({
      code: 'UNAUTHORIZED',
      message: '未授权访问',
    });
  }
  
  if (!isAdmin(ctx.user)) {
    throw new TRPCError({
      code: 'FORBIDDEN',
      message: '需要管理员权限',
    });
  }
  
  return next();
});

/**
 * 创建资源所有者权限中间件
 */
export const requireOwner = (getResource: (input: any) => any) =>
  t.middleware(async ({ ctx, next, input }) => {
    if (!ctx.user) {
      throw new TRPCError({
        code: 'UNAUTHORIZED',
        message: '未授权访问',
      });
    }
    
    // 获取资源（需要在 procedure 中提供）
    const resource = await getResource(input);
    
    if (!isOwner(ctx.user, resource) && !isAdmin(ctx.user)) {
      throw new TRPCError({
        code: 'FORBIDDEN',
        message: '无权访问该资源',
      });
    }
    
    return next();
  });
```

#### 2.3 运行测试

```bash
bun test tests/unit/permissions.test.ts
```

### 步骤 3: 改造用户管理接口（TDD）

#### 3.1 编写测试

#### 3.2 实现改造
- 应用 `requireAdmin` 中间件
- 应用响应包装
- 脱敏和转换数据

#### 3.3 运行测试

### 步骤 4: 改造其他接口

按照相同模式改造其他接口。

---

## 📊 预期成果

### 1. 统一响应格式

所有接口返回统一格式：
```json
{
  "success": true,
  "data": { ... },
  "message": "操作成功"
}
```

### 2. 权限控制

- ✅ 公开接口：无需登录
- ✅ 认证接口：需要登录
- ✅ 管理员接口：仅管理员
- ✅ 所有者接口：仅资源所有者或管理员

### 3. 数据安全

- ✅ 密码永不返回
- ✅ 令牌按需返回
- ✅ 敏感字段自动过滤
- ✅ 字段命名统一

### 4. 测试覆盖

- ✅ 单元测试：工具函数
- ✅ 集成测试：接口改造
- ✅ 权限测试：权限控制

---

## 📅 时间估算

| 阶段 | 任务 | 预计时间 |
|------|------|----------|
| 阶段一 | 改造认证接口 | 1-2天 |
| 阶段二 | 完善权限中间件 | 1天 |
| 阶段三 | 改造用户管理接口 | 1-2天 |
| 阶段四 | 改造帖子接口 | 1天 |
| 阶段五 | 改造互动接口 | 1天 |
| 阶段六 | 改造题库接口 | 1天 |
| 阶段七 | 更新 API 文档 | 1天 |
| **总计** | - | **7-9天** |

---

## 🎯 下一步行动

1. **审查本计划** - 确认需求和优先级
2. **开始实施** - 按阶段逐步改造
3. **持续测试** - 每改一个接口就测试
4. **更新文档** - 及时同步更新

---

## 📝 注意事项

### TDD 流程

1. **红** - 编写失败的测试
2. **绿** - 编写最简单的代码使测试通过
3. **重构** - 优化代码质量

### 权限检查

- 认证检查优先
- 角色检查其次
- 资源检查最后
- 管理员有所有权限

### 数据脱敏

- 在返回前脱敏
- 不要修改原始数据
- 保留必要字段

---

**文档创建日期**: 2026-01-30  
**文档版本**: 1.0  
**负责人**: 后端团队