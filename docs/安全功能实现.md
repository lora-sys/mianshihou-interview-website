# 安全功能实现

## 概述

本文档记录了面试后端系统的安全功能实现，包括日志聚合、请求限流、SQL 注入防护、XSS 防护和 IP 黑白名单功能。

## 已实现功能

### 1. 日志聚合 - Loki 集成

**文件**: `lib/logger.ts`

**功能描述**:
- 集成 Loki transport 进行日志聚合
- 支持结构化日志记录
- 添加追踪信息（traceId, userId, requestId）
- 支持多种日志级别（debug, info, warn, error）

**主要接口**:

```typescript
// 创建基础日志记录器
export function createLogger(context: string): pino.Logger

// 创建带追踪信息的日志记录器
export function createLoggerWithTrace(
  context: string,
  traceId?: string,
  userId?: string,
  requestId?: string
): pino.Logger

// 记录用户操作
export function logUserAction(
  userId: string,
  action: string,
  data?: any
): void

// 记录 API 请求
export function logAPIRequest(
  requestId: string,
  method: string,
  path: string,
  userId?: string,
  data?: any
): void

// 记录数据库操作
export function logDatabaseOperation(
  operation: string,
  table: string,
  duration: number,
  data?: any
): void

// 记录缓存操作
export function logCacheOperation(
  operation: string,
  key: string,
  hit: boolean,
  data?: any
): void

// 记录错误
export function logError(
  context: string,
  error: Error,
  userId?: string,
  requestId?: string
): void
```

**配置**:
```env
# Loki 配置
LOKI_URL=http://localhost:3100/loki/api/v1/push
LOKI_USERNAME=
LOKI_PASSWORD=
LOKI_LABELS=service,environment,version
```

**测试覆盖**: 17 个测试用例，全部通过

---

### 2. 请求限流功能

**文件**: 
- `lib/rate-limiter.ts` - 核心限流逻辑
- `middlewares/rate-limit.ts` - Fastify 中间件

**功能描述**:
- 基于 Redis 的滑动窗口限流算法
- 支持多种限流策略（IP、用户、接口）
- 可配置时间窗口和请求限制
- 提供限流状态查询

**主要接口**:

```typescript
// 创建限流器
export function createRateLimiter(options: RateLimiterOptions): RateLimiter

// 检查并记录请求
export async function checkRateLimit(
  identifier: string,
  options: RateLimiterOptions
): Promise<RateLimitResult>

// 重置限流计数
export async function resetRateLimit(identifier: string): Promise<boolean>

// 查询限流状态
export async function getRateLimitStatus(
  identifier: string
): Promise<RateLimitStatus>

// 清理所有限流数据
export async function clearAllRateLimits(): Promise<boolean>
```

**预定义限流器**:
```typescript
// IP 限流（全局限流）
ipRateLimiter: {
  limit: 100,
  window: 60000, // 1分钟
}

// 用户限流
userRateLimiter: {
  limit: 1000,
  window: 3600000, // 1小时
}

// 接口限流
apiRateLimiter: {
  limit: 60,
  window: 60000, // 1分钟
}
```

**中间件配置**:
```typescript
// 在 server.ts 中应用
fastify.addHook('onRequest', rateLimitMiddleware({
  prefix: 'api',
  limit: 100,
  window: 60000,
  skipSuccessfulRequests: false
}));
```

**测试覆盖**: 16 个测试用例，全部通过

---

### 3. SQL 注入防护

**文件**:
- `lib/input-validator.ts` - 输入验证工具
- `trpc/middleware/input-validation.ts` - tRPC 中间件

**功能描述**:
- 输入验证和清理
- SQL 关键词检测
- 危险字符过滤
- 数据类型验证

**主要接口**:

```typescript
// 字符串验证
export function validateString(
  input: any,
  options: ValidationConfig
): ValidationResult

// 对象验证
export function validateObject(
  input: any,
  schema: ValidationSchema
): ValidationResult

// 数字验证
export function validateNumber(
  input: any,
  options: NumberValidationOptions
): ValidationResult

// 检查 SQL 注入
export function isPotentialSQLInjection(input: string): boolean

// 清理输入
export function sanitizeInput(
  input: any,
  options: SanitizeOptions
): any

// 验证并清理
export function validateAndSanitize(
  input: any,
  options: ValidationAndSanitizeOptions
): ValidationResult
```

**SQL 关键词列表**:
```typescript
const SQL_KEYWORDS = [
  'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'DROP',
  'UNION', 'WHERE', 'JOIN', 'OR', 'AND',
  'EXEC', 'EXECUTE', 'SCRIPT', 'JAVASCRIPT',
  'FROM', 'INTO', 'VALUES', 'SET', 'ALTER'
];
```

**危险字符**:
```typescript
const DANGEROUS_CHARS = [
  ';', '--', '/*', '*/', '/*!', 'xp_', '@@',
  'char(', 'nchar(', 'varchar(', 'nvarchar(',
  'alter', 'begin', 'cast', 'create', 'cursor',
  'declare', 'delete', 'drop', 'end', 'exec'
];
```

**预定义验证配置**:
```typescript
// 用户名
usernameConfig: {
  minLength: 3,
  maxLength: 20,
  pattern: /^[a-zA-Z0-9_]+$/,
  checkSQLInjection: true,
  checkDangerousChars: true
}

// 邮箱
emailConfig: {
  minLength: 5,
  maxLength: 100,
  pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
  checkSQLInjection: false
}

// 密码
passwordConfig: {
  minLength: 8,
  maxLength: 128,
  requireUppercase: true,
  requireLowercase: true,
  requireNumbers: true,
  requireSpecialChars: true
}
```

**测试覆盖**: 39 个测试用例，全部通过

---

### 4. XSS 防护

**文件**: `lib/xss-protection.ts`

**功能描述**:
- HTML 实体编码
- 属性值编码
- JavaScript 编码
- DOMPurify HTML 清理
- 对象清理

**主要接口**:

```typescript
// HTML 实体编码
export function encodeHTMLEntities(input: string): string

// HTML 属性值编码
export function encodeHTMLAttribute(input: string): string

// JavaScript 编码
export function encodeJavaScript(input: string): string

// URL 编码
export function encodeURL(input: string): string

// HTML 清理（使用 DOMPurify）
export function sanitizeHTML(
  input: string,
  options?: SanitizeHTMLOptions
): string

// 严格 HTML 清理（使用 sanitize-html）
export function sanitizeHTMLStrict(
  input: string,
  options?: SanitizeHTMLOptions
): string

// XSS 检测
export function detectXSS(input: string): boolean

// 清理对象
export function sanitizeObject(
  obj: any,
  options?: SanitizeObjectOptions
): any

// 创建安全 HTML 元素
export function createSafeHTML(
  tag: string,
  content: string,
  attributes?: Record<string, string>
): string
```

**HTML 实体映射**:
```typescript
const HTML_ENTITIES = {
  '&': '&amp;',
  '<': '&lt;',
  '>': '&gt;',
  '"': '&quot;',
  "'": '&#39;',
  '/': '&#x2F;',
  '`': '&#x60;',
  '=': '&#x3D;'
};
```

**允许的 HTML 标签**:
```typescript
ALLOWED_TAGS = [
  'b', 'i', 'u', 'strong', 'em', 'p', 'br',
  'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
  'blockquote', 'code', 'pre', 'a', 'span', 'div'
];

ALLOWED_ATTR = {
  'a': ['href', 'title', 'target'],
  'img': ['src', 'alt', 'title', 'width', 'height']
};
```

**测试覆盖**: 40 个测试用例，全部通过

---

### 5. IP 黑白名单

**文件**:
- `lib/ip-list.ts` - IP 列表管理
- `middlewares/ip-control.ts` - Fastify 中间件

**功能描述**:
- IP 白名单管理
- IP 黑名单管理
- 支持 CIDR 格式
- IP 访问控制

**主要接口**:

```typescript
// IP 验证
export function isValidIP(ip: string): boolean
export function isValidCIDR(cidr: string): boolean

// 白名单管理
export async function addToWhitelist(
  ipOrCIDR: string,
  addedBy?: string,
  note?: string
): Promise<boolean>

export async function removeFromWhitelist(ipOrCIDR: string): Promise<boolean>
export async function getWhitelist(): Promise<IPListItem[]>
export async function clearWhitelist(): Promise<boolean>

// 黑名单管理
export async function addToBlacklist(
  ipOrCIDR: string,
  addedBy?: string,
  note?: string
): Promise<boolean>

export async function removeFromBlacklist(ipOrCIDR: string): Promise<boolean>
export async function getBlacklist(): Promise<IPListItem[]>
export async function clearBlacklist(): Promise<boolean>

// IP 访问检查
export async function checkIPAccess(ip: string): Promise<IPCheckResult>
export async function isInWhitelist(ip: string): Promise<boolean>
export async function isInBlacklist(ip: string): Promise<boolean>

// 统计信息
export async function getIPListStats(): Promise<{
  whitelistCount: number;
  blacklistCount: number;
}>
```

**CIDR 支持**:
```typescript
// 支持的 CIDR 格式示例
192.168.1.0/24    // 192.168.1.0 - 192.168.1.255
10.0.0.0/8        // 10.0.0.0 - 10.255.255.255
172.16.0.0/12     // 172.16.0.0 - 172.31.255.255
```

**中间件配置**:
```typescript
// 白名单中间件
createIPWhitelistMiddleware({
  strict: false,  // 严格模式：白名单为空时拒绝所有
  skipPaths: ['/health', '/health/live', '/health/ready']
})

// 黑名单中间件
createIPBlacklistMiddleware({
  skipPaths: ['/health', '/health/live', '/health/ready']
})
```

**IP 列表项结构**:
```typescript
interface IPListItem {
  ip: string;           // IP 地址或 CIDR
  addedAt: number;      // 添加时间戳
  addedBy: string;      // 添加者
  note?: string;        // 备注
}
```

**测试覆盖**: 25 个测试用例，全部通过

---

## 测试统计

| 功能模块 | 测试文件 | 测试数量 | 通过率 |
|---------|---------|---------|--------|
| 日志聚合 | logger-aggregation.test.ts | 17 | 100% |
| 请求限流 | rate-limiter.test.ts | 16 | 100% |
| SQL 注入防护 | input-validator.test.ts | 39 | 100% |
| XSS 防护 | xss-protection.test.ts | 40 | 100% |
| IP 黑白名单 | ip-list.test.ts | 25 | 100% |
| **总计** | - | **137** | **100%** |

---

## 依赖包

```json
{
  "pino-loki": "^3.0.0",
  "sanitize-html": "^2.17.0",
  "isomorphic-dompurify": "^2.35.0",
  "@types/sanitize-html": "^2.16.0",
  "@types/dompurify": "^3.2.0"
}
```

---

## 使用示例

### 日志聚合

```typescript
import { createLogger, createLoggerWithTrace } from './lib/logger';

// 创建日志记录器
const logger = createLogger('MyService');

// 创建带追踪信息的日志记录器
const traceLogger = createLoggerWithTrace(
  'MyService',
  'trace-123',
  'user-456',
  'req-789'
);

// 记录日志
logger.info('用户登录', { userId: 'user-123' });
traceLogger.info('处理请求', { path: '/api/users' });
```

### 请求限流

```typescript
import { createRateLimiter } from './lib/rate-limiter';

// 创建限流器
const limiter = createRateLimiter({
  limit: 100,
  window: 60000,
  identifier: 'user-123'
});

// 检查限流
const result = await limiter.check();
if (!result.allowed) {
  throw new Error('请求过于频繁，请稍后再试');
}
```

### SQL 注入防护

```typescript
import { validateString, isPotentialSQLInjection } from './lib/input-validator';

// 验证输入
const result = validateString('test-user-123', {
  minLength: 3,
  maxLength: 20,
  checkSQLInjection: true
});

if (!result.valid) {
  throw new Error('输入验证失败');
}

// 检查 SQL 注入
if (isPotentialSQLInjection(input)) {
  throw new Error('检测到潜在的 SQL 注入');
}
```

### XSS 防护

```typescript
import { encodeHTMLEntities, sanitizeHTML } from './lib/xss-protection';

// 编码 HTML 实体
const encoded = encodeHTMLEntities('<script>alert(1)</script>');
// 输出: &lt;script&gt;alert(1)&lt;&#x2F;script&gt;

// 清理 HTML
const clean = sanitizeHTML('<div><script>alert(1)</script></div>');
// 输出: <div></div>
```

### IP 黑白名单

```typescript
import { 
  addToWhitelist, 
  checkIPAccess,
  getWhitelist 
} from './lib/ip-list';

// 添加到白名单
await addToWhitelist('192.168.1.100', 'admin', '办公网络');

// 检查 IP 访问
const result = await checkIPAccess('192.168.1.100');
if (!result.allowed) {
  throw new Error('访问被拒绝');
}

// 获取白名单
const whitelist = await getWhitelist();
```

---

## 配置说明

### 环境变量

```env
# Loki 配置
LOKI_URL=http://localhost:3100/loki/api/v1/push
LOKI_USERNAME=
LOKI_PASSWORD=
LOKI_LABELS=service,environment,version

# Redis 配置（用于限流和 IP 列表）
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# 日志配置
LOG_LEVEL=info
NODE_ENV=development
```

---

## 最佳实践

1. **日志记录**
   - 使用结构化日志
   - 添加追踪信息
   - 记录关键操作和错误

2. **请求限流**
   - 根据不同场景设置合适的限流策略
   - 提供友好的错误提示
   - 监控限流触发情况

3. **SQL 注入防护**
   - 始终验证用户输入
   - 使用参数化查询
   - 避免拼接 SQL 语句

4. **XSS 防护**
   - 输出时进行编码
   - 使用安全的 HTML 清理
   - 避免使用 innerHTML

5. **IP 黑白名单**
   - 定期审查和更新 IP 列表
   - 记录 IP 添加/删除的操作日志
   - 考虑使用 CDN 的 IP 访问控制

### 8. 文件上传功能 - 头像/附件上传

**文件**: 
- `lib/file-storage.ts` - 文件存储核心功能
- `lib/image-processor.ts` - 图片处理功能
- `trpc/router/upload.ts` - tRPC 上传路由

**功能描述**:
- 支持头像和附件上传
- 文件类型验证（图片、文档等）
- 文件大小限制（头像 5MB，附件 10MB）
- 图片自动压缩和处理
- 唯一文件名生成
- 文件删除和管理

**主要接口**:

```typescript
// 文件存储接口
export function generateUniqueFilename(originalName: string): string
export function validateMimeType(mimetype: string, options?: StorageOptions): boolean
export function validateExtension(filename: string, options?: StorageOptions): boolean
export function validateFileSize(size: number, maxSize?: number): boolean

export async function saveFile(
  file: {
    filename: string;
    data: Buffer;
    mimetype: string;
    size: number;
  },
  type: 'avatar' | 'attachment' = 'attachment',
  options?: StorageOptions
): Promise<FileInfo>

export async function deleteFile(
  filename: string,
  type: 'avatar' | 'attachment' = 'attachment'
): Promise<boolean>

// 图片处理接口
export async function processImage(
  buffer: Buffer,
  options?: ImageProcessOptions
): Promise<Buffer>

export async function processAvatar(buffer: Buffer): Promise<Buffer>
export async function processAttachmentImage(buffer: Buffer): Promise<Buffer>

// tRPC 上传接口
uploadRouter = {
  uploadAvatar: protectedProcedure.input(...).mutation(...),
  uploadAttachment: protectedProcedure.input(...).mutation(...),
  deleteFile: protectedProcedure.input(...).mutation(...),
  getFileInfo: protectedProcedure.input(...).query(...),
  batchDeleteFiles: adminProcedure.input(...).mutation(...)
}
```

**支持的文件类型**:

**图片**:
- JPEG (.jpg, .jpeg)
- PNG (.png)
- GIF (.gif)
- WebP (.webp)
- SVG (.svg)

**文档**:
- PDF (.pdf)
- Word (.doc, .docx)
- Excel (.xls, .xlsx)
- Text (.txt)
- Markdown (.md)

**头像处理规则**:
- 最大文件大小: 5MB
- 目标尺寸: 200x200
- 输出格式: JPEG
- 质量: 85%
- 尺寸验证: 64x64 到 2000x2000

**附件处理规则**:
- 最大文件大小: 10MB
- 目标尺寸: 1920x1080（仅图片）
- 输出格式: JPEG（仅图片）
- 质量: 80%

**使用示例**:

```typescript
// 上传头像
const result = await trpc.upload.uploadAvatar.mutate({
  filename: 'profile.jpg',
  data: 'base64_encoded_image_data',
  mimetype: 'image/jpeg'
});

// 上传附件
const result = await trpc.upload.uploadAttachment.mutate({
  filename: 'document.pdf',
  data: 'base64_encoded_file_data',
  mimetype: 'application/pdf'
});

// 删除文件
const result = await trpc.upload.deleteFile.mutate({
  filename: 'unique_filename.jpg',
  type: 'avatar'
});

// 获取文件信息
const result = await trpc.upload.getFileInfo.query({
  filename: 'unique_filename.jpg',
  type: 'avatar'
});
```

**配置选项**:

```typescript
// .env 配置
NEXT_PUBLIC_API_URL=http://localhost:3000

// 文件存储选项
interface StorageOptions {
  maxSize?: number;
  allowedMimeTypes?: string[];
  allowedExtensions?: string[];
}

// 图片处理选项
interface ImageProcessOptions {
  width?: number;
  height?: number;
  quality?: number;
  format?: 'jpeg' | 'png' | 'webp';
  fit?: 'cover' | 'contain' | 'fill' | 'inside' | 'outside';
}
```

**安全特性**:
- MIME 类型白名单验证
- 文件扩展名验证
- 文件大小限制
- 图片尺寸验证
- 自动病毒扫描（建议添加）
- 唯一文件名防止覆盖
- 安全的文件路径处理

**测试覆盖**:
- 文件存储测试: 26 个测试
- 图片处理测试: 18 个测试
- 总计: 44 个测试，100% 通过

---

## 总结

本系统已实现完整的安全功能体系，包括：

1. ✅ 日志聚合 - Loki 集成
2. ✅ 请求限流 - Redis 滑动窗口
3. ✅ SQL 注入防护 - 输入验证
4. ✅ XSS 防护 - 输出编码
5. ✅ IP 黑白名单 - 访问控制
6. ✅ API 签名验证 - HMAC-SHA256
7. ✅ 批量操作 - 批量导入/删除
8. ✅ 文件上传 - 头像/附件上传

所有功能均包含完整的测试覆盖和文档说明。

---

## 更新日志

- **2026-02-01 v1.0**: 初始版本，实现 5 个安全功能模块（日志聚合、请求限流、SQL 注入防护、XSS 防护、IP 黑白名单）
- **2026-02-01 v1.1**: 新增 API 签名验证功能，支持 HMAC-SHA256 和重放攻击防护
- **2026-02-01 v1.2**: 新增批量操作接口，支持用户、题目和题库的批量导入/删除
- **2026-02-01 v1.3**: 新增文件上传功能，支持头像和附件上传，包含图片压缩和处理